<div th:fragment="pos-main">

    <style type="text/css">


        /* Set flexbox for the pos-container */
        .pos-container {
            display: flex;
            flex-direction: column;
            height: auto;
        }

        /* Set flex for pos-content */
        .pos-content {
            display: flex;
            flex: 1;
        }

        /* Style pos-content-container */
        .pos-content-container {
            flex: 1;
            padding: 10px;
        }

        /* Style pos-sidebar */
        .pos-sidebar {

            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            position: sticky;
            top: 0;
            height: auto;
            display: flex;
            flex-direction: column;

        }
    </style>


    <div class="row">
        <div class="col-md-12">
            <div class="card p-1">
                <div class="pos-container">

                    <!-- pos-content -->
                    <div class="pos-content">
                        <div class="col-md-12">


                            <div class="card mb-3">
                                <div class="card-header bg-light py-2 d-flex justify-content-between align-items-center">
                                    <h6 class="card-title mb-0">Purchase & Invoice Details</h6>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="convertToPurchase">
                                        <label class="form-check-label" for="convertToPurchase">Convert PO to Purchase</label>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- First Row -->
                                    <div class="row mb-3">
                                        <!-- Purchase Order Selection -->
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label for="purchaseOrder" class="form-label">Purchase Order:</label>
                                                <select class="form-select form-select-sm" id="purchaseOrder">
                                                    <option value="">Select PO</option>
                                                    <option value="PO-10001">PO-10001 (Pending)</option>
                                                    <option value="PO-10002">PO-10002 (Approved)</option>
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Invoice Number -->
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label for="invoiceNumber" class="form-label">Invoice Number:</label>
                                                <input type="text" class="form-control form-control-sm" id="invoiceNumber" placeholder="Enter Invoice #">
                                            </div>
                                        </div>

                                        <!-- Purchase Date -->
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label for="purchaseDate" class="form-label">Purchase Date:</label>
                                                <div class="input-group">
                                                    <input type="date" id="purchaseDate" name="purchaseDate" class="form-control form-control-sm"/>
                                                    <span class="input-group-text"><i class="fa fa-calendar"></i></span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Payment Type -->
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label for="paymentType" class="form-label">Payment Type:</label>
                                                <select class="form-control form-control-sm" id="paymentType">
                                                    <option value="CASH">Cash</option>
                                                    <option value="CREDIT">Credit</option>
                                                    <option value="BANK_TRANSFER">Bank Transfer</option>
                                                    <option value="CHEQUE">Cheque</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Second Row -->
                                    <div class="row mb-3">
                                        <!-- Vendor Selection -->
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label for="supplierId" class="form-label">Supplier:</label>
                                                <div class="input-group">
                                                    <select id="supplierId" name="supplierSearch" class="form-select form-select-sm">
                                                        <option value="">Select Supplier</option>

                                                    </select>
                                                    <button class="btn btn-secondary btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#supplierModal">
                                                        <i class="fa fa-plus"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Reference Number -->
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label for="referenceNumber" class="form-label">Reference #:</label>
                                                <input type="text" class="form-control form-control-sm" id="referenceNumber" placeholder="Enter Ref #">
                                            </div>
                                        </div>

                                        <!-- Location -->
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label for="stationId" class="form-label">Store/Location:</label>
                                                <select class="form-control form-control-sm" id="stationId">
                                                    <option value="">Select Location</option>

                                                </select>
                                            </div>
                                        </div>

                                        <!-- Attachments -->
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label for="attachments" class="form-label">Attachments:</label>
                                                <div class="input-group">
                                                    <input type="file" class="form-control form-control-sm" id="attachments" multiple>
                                                    <button class="btn btn-outline-secondary btn-sm" type="button">
                                                        <i class="fa fa-paperclip"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Action Buttons -->
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="text-end">
                                                <button type="button" class="btn btn-outline-info btn-sm me-2" id="btnViewPO">
                                                    <i class="fa fa-eye"></i> View PO
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary btn-sm me-2" id="btnViewHistory">
                                                    <i class="fa fa-history"></i> History
                                                </button>
                                                <button type="button" class="btn btn-success btn-sm me-2" id="btnSaveAsPurchase">
                                                    <i class="fa fa-shopping-cart"></i> Save Purchase
                                                </button>
                                                <button type="button" class="btn btn-danger btn-sm" id="btnCancel">
                                                    <i class="fa fa-times"></i> Cancel
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>




                            <!-- pos-content-container -->
                            <div class="pos-content-container">
                                <div class="pos-table-row">
                                    <!-- Add your table rows here -->
                                    <!-- BEGIN input-group -->
                                    <div class="input-group p-2">
                                        <button class="btn btn-dark dropdown-toggle py-0" type="button" data-bs-toggle="dropdown" style="height: 38px;">
                                            <span class="d-none d-md-inline">Search Products</span>
                                            <span class="d-inline d-md-none"><i class="fa fa-search"></i></span>
                                            <i class="fa fa-barcode ms-1"></i>
                                        </button>
                                        <div class="flex-grow-1 position-relative">
                                            <div class="input-group">
                                              <span class="input-group-text bg-light border-0 py-0 px-2" style="height: 38px;">
                                                <i class="fa fa-barcode"></i>
                                              </span>
                                                <input type="text" class="form-control bg-light border-start-0" placeholder="Search products..." id="search-pos" style="height: 38px;">
                                            </div>
                                            <div id="productTableContainer-pos" class="position-absolute w-100 bg-white border mt-1" style="display: none; z-index: 1000;"></div>
                                        </div>
                                    </div>
                                    <!-- END input-group -->
                                    <input type="hidden" id="barcode-input">

                                    <!-- BEGIN panel -->
                                    <div class="panel rounded border" data-sortable-id="ui-widget-16">
                                        <div class="panel-heading bg-default-700 text-white">

                                            <div class="panel-heading-btn">
                                                <a href="javascript:;" class="btn btn-xs btn-icon btn-default" data-toggle="panel-expand"><i class="fa fa-expand"></i></a>
                                                <a href="javascript:;" class="btn btn-xs btn-icon btn-success" data-toggle="panel-reload"><i class="fa fa-redo"></i></a>
                                                <a href="javascript:;" class="btn btn-xs btn-icon btn-warning" data-toggle="panel-collapse"><i class="fa fa-minus"></i></a>
                                                <a href="javascript:;" class="btn btn-xs btn-icon btn-danger" data-toggle="panel-remove"><i class="fa fa-times"></i></a>
                                            </div>

                                        </div>


                                        <div class="panel-body">
                                            <!-- BEGIN table -->
                                            <div class="table-responsive mb-3">
                                                <table class="table table-hover table-bordered table-sm text-nowrap mb-0 rounded border bg-gradient" id="selectedProducts-pos">
                                                    <thead>
                                                    <tr>
                                                        <th>Code</th>
                                                        <th>Product Name</th>
                                                        <th>Quantity</th>
                                                        <th>UnitCost</th>
                                                        <th>UnitTax</th>
                                                        <th>Discount</th>
                                                        <th>NetTax</th>
                                                        <th>SubTotal</th>
                                                        <th>Batch Number</th>
                                                        <th>Expiry Date</th>
                                                        <th>Action</th>

                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    </tbody>
                                                </table>
                                                <fieldset class="border p-2">
                                                    <div class="mailbox-content-footer">
                                                    </div>
                                                </fieldset>
                                            </div>
                                            <!-- END table -->
                                        </div>

                                    </div>
                                    <!-- END panel -->
                                </div>

                            </div>
                            <!-- END pos-content-container -->
                        </div>


                    </div>
                    <!-- END pos-content -->

                </div>
            </div>
        </div>
    </div>
















    <script>
        $(document).ready(function() {
            const POS = {
                init() {
                    this.cacheDOM();
                    this.bindEvents();
                    this.initBarcodeScanner();
                    this.$searchInput.focus();
                },

                cacheDOM() {
                    this.$searchInput = $('#search-pos');
                    this.$productTableContainer = $('#productTableContainer-pos');
                    this.$selectedProductsTable = $('#selectedProducts-pos');
                    this.$receivedAmount = $('#receivedAmount');
                },

                bindEvents() {
                    this.$searchInput.on('input', this.debounce(this.handleSearch.bind(this), 300));
                    this.$productTableContainer.on('click', 'tbody tr', this.handleProductSelection.bind(this));
                    $(document).on('input', '.product-input, .price-input, .discount-input', this.handleInputChange.bind(this));
                    $(document).on('click', '.increase-qty', this.handleQuantityIncrease.bind(this));
                    $(document).on('click', '.decrease-qty', this.handleQuantityDecrease.bind(this));
                    $(document).on('click', '.remove-row', (e) => this.removeRow($(e.currentTarget).closest('tr')));
                    $(document).on('change', '.expiry-date', this.handleExpiryDateChange.bind(this));
                    $(document).on('input', '.batch-input', this.handleBatchChange.bind(this));
                    this.$receivedAmount.on('input', this.updateSidebar.bind(this));
                    this.$selectedProductsTable.on('click', 'tbody tr', this.handleRowSelection.bind(this));
                },

                debounce(func, wait) {
                    let timeout;
                    return (...args) => {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func.apply(this, args), wait);
                    };
                },

                initBarcodeScanner() {
                    let scanBuffer = '';
                    let lastKeyTime = Date.now();
                    let lastScanTime = 0;
                    const scanCompleteDelay = 50;
                    const minTimeBetweenScans = 1000;

                    $(document).on('keydown', (e) => {
                        const currentTime = Date.now();

                        if (e.key === 'Enter' && scanBuffer.length > 0 && currentTime - lastScanTime > minTimeBetweenScans) {
                            e.preventDefault();
                            this.handleBarcodeScan(scanBuffer);
                            scanBuffer = '';
                            lastScanTime = currentTime;
                            return false;
                        }

                        if (currentTime - lastKeyTime > scanCompleteDelay) {
                            scanBuffer = '';
                        }

                        if (e.key.length === 1) {
                            scanBuffer += e.key;
                        }

                        lastKeyTime = currentTime;

                        if ($(e.target).is(this.$searchInput)) {
                            return true;
                        }

                        if (scanBuffer.length > 1) {
                            e.preventDefault();
                            return false;
                        }
                    });
                },

                handleSearch() {
                    const inputValue = this.$searchInput.val().trim();
                    if (inputValue.length > 0) {
                        this.searchProducts(inputValue);
                    } else {
                        this.$productTableContainer.hide();
                    }
                },

                searchProducts(searchKey, page = 0, size = 5) {
                    if (!searchKey || searchKey.trim() === '') {
                        console.log('Empty search key, not performing search');
                        return;
                    }

                    $.ajax({
                        url: '/products/products-data',
                        type: 'GET',
                        data: { searchKey, page, size },
                        success: (response) => {
                            if (response && response.trim() !== '') {
                                this.$productTableContainer.html(response).show();
                            } else {
                                this.$productTableContainer.html('<p>No products found.</p>').show();
                            }
                        },
                        error: (e) => {
                            console.log('Search error:', e);
                            this.$productTableContainer.html('<p>Error loading products.</p>').show();
                        }
                    });
                },

                handleProductSelection(event) {
                    event.preventDefault();
                    const $selectedRow = $(event.currentTarget);
                    this.addProductToSelection($selectedRow);
                    this.$productTableContainer.hide();
                    this.$searchInput.val('').focus();
                },

                handleBarcodeScan(barcode) {
                    if (/^\d+$/.test(barcode)) {
                        console.log(`Scanned barcode: ${barcode}`);
                        this.getProductAndAddRow(barcode);
                        this.$searchInput.val('').focus();
                    } else {
                        console.log('Invalid barcode:', barcode);
                        alert('Invalid barcode scanned');
                    }
                },

                getProductAndAddRow(productCode) {
                    if (!productCode || productCode.trim() === '') {
                        console.log('Empty product code, not fetching product');
                        return;
                    }

                    $.ajax({
                        url: `/api-bulk/SearchByCode_All/${productCode}`,
                        type: 'GET',
                        success: (data) => {
                            if (data && data.productCode) {
                                this.addProductToRow(data.productCode, data.productName, data.productPrice, data.tax);
                            } else {
                                console.error('Invalid product data received');
                            }
                        },
                        error: (error) => {
                            console.error('Error:', error);
                            console.log('Product not found or error occurred.');
                        }
                    });
                },

                addProductToSelection($productRow) {
                    const productCode = $productRow.find('td:nth-child(1)').text();
                    const productName = $productRow.find('td:nth-child(2)').text();
                    const productPrice = parseFloat($productRow.find('td:nth-child(4)').text()) || 0;
                    const unitTax = parseFloat($productRow.find('td:nth-child(5)').text()) || 0;

                    this.addProductToRow(productCode, productName, productPrice, unitTax);
                },

                addProductToRow(productCode, productName, productPrice, unitTax) {
                    const $existingRow = this.$selectedProductsTable.find(`tbody tr[data-product-code="${productCode}"]`);

                    if ($existingRow.length) {
                        const $qtyInput = $existingRow.find('.product-input');
                        $qtyInput.val(parseInt($qtyInput.val()) + 1).trigger('input');
                    } else {
                        const currentDate = new Date().toISOString().split('T')[0];
                        const newRow = `
                    <tr data-product-code="${productCode}">
                        <td key-id="productCode">${productCode}</td>
                        <td key-id="productName">${productName}</td>
                        <td key-id="productQty" style="white-space: nowrap;">
                            <div class="input-group qty">
                                <button class="btn btn-danger btn-sm decrease-qty"><i class="fa fa-minus fa-sm"></i></button>
                                <input type="text" class="form-control form-control-sm text-center product-input"
                                    value="1" style="width: 50px; margin: 0 5px;" />
                                <button class="btn btn-success btn-sm increase-qty"><i class="fa fa-plus fa-sm"></i></button>
                            </div>
                        </td>
                        <td key-id="SalePrice">
                            <input type="number" class="form-control form-control-sm price-input"
                                value="${productPrice}" step="0.01" />
                        </td>
                        <td key-id="unitTax">${this.formatNumber(unitTax)}</td>
                        <td key-id="discount">
                            <input type="number" class="form-control form-control-sm discount-input"
                                value="0.00" step="0.01" />
                        </td>
                        <td key-id="finalTax">${this.formatNumber(unitTax)}</td>
                        <td key-id="subtotal">${this.formatNumber(productPrice + unitTax)}</td>
                        <td key-id="batchNumber">
                            <input type="text" class="form-control form-control-sm batch-input" />
                        </td>
                        <td key-id="expiryDate">
                            <input type="date" class="form-control form-control-sm expiry-date"
                                value="${currentDate}" min="${currentDate}" />
                        </td>
                        <td key-id="action">
                            <button class="btn btn-danger btn-sm remove-row">
                                <i class="fa fa-trash fa-sm"></i>
                            </button>
                        </td>
                    </tr>
                `;

                        this.$selectedProductsTable.find('tbody').prepend(newRow);
                        this.updateRowTotals(this.$selectedProductsTable.find(`tbody tr[data-product-code="${productCode}"]`));
                    }

                    this.updateSidebar();
                },

                handleInputChange(event) {
                    const $input = $(event.target);
                    const $row = $input.closest('tr');

                    if ($input.hasClass('product-input')) {
                        let qty = parseInt($input.val());
                        if (isNaN(qty) || qty < 0) {
                            qty = 1;
                        }
                        $input.val(qty);

                        if (qty === 0) {
                            this.removeRow($row);
                            return;
                        }
                    } else if ($input.hasClass('price-input')) {
                        let price = parseFloat($input.val());
                        if (isNaN(price) || price < 0) {
                            price = 0;
                        }
                        $input.val(this.formatNumber(price));
                    } else if ($input.hasClass('discount-input')) {
                        let discount = parseFloat($input.val());
                        if (isNaN(discount) || discount < 0) {
                            discount = 0;
                        }
                        $input.val(this.formatNumber(discount));
                    }

                    this.updateRowTotals($row);
                    this.updateSidebar();
                },

                handleQuantityIncrease(event) {
                    event.preventDefault();
                    const $input = $(event.currentTarget).closest('.qty').find('.product-input');
                    let qty = parseInt($input.val()) + 1;
                    $input.val(qty).trigger('input');
                },

                handleQuantityDecrease(event) {
                    event.preventDefault();
                    const $input = $(event.currentTarget).closest('.qty').find('.product-input');
                    let qty = Math.max(0, parseInt($input.val()) - 1);
                    $input.val(qty).trigger('input');
                },

                handleExpiryDateChange(event) {
                    const $input = $(event.target);
                    const selectedDate = new Date($input.val());
                    const currentDate = new Date();

                    if (selectedDate < currentDate) {
                        alert('Expiry date cannot be in the past');
                        $input.val(currentDate.toISOString().split('T')[0]);
                    }
                },

                handleBatchChange(event) {
                    const $input = $(event.target);
                    const batchNumber = $input.val().trim();

                    // Add any specific batch number validation if needed
                    if (batchNumber === '') {
                        console.log('Empty batch number entered');
                    }
                },

                updateRowTotals($row) {
                    const qty = parseInt($row.find('.product-input').val()) || 0;
                    const price = parseFloat($row.find('.price-input').val()) || 0;
                    const discount = parseFloat($row.find('.discount-input').val()) || 0;
                    const unitTax = parseFloat($row.find('[key-id="unitTax"]').text()) || 0;

                    const finalTax = unitTax * qty;
                    const subtotal = this.calculateSubtotal(price, qty, discount, unitTax);

                    $row.find('[key-id="finalTax"]').text(this.formatNumber(finalTax));
                    $row.find('[key-id="subtotal"]').text(this.formatNumber(subtotal));
                },

                updateSidebar() {
                    let subtotal = 0;
                    let tax = 0;
                    let discount = 0;

                    this.$selectedProductsTable.find('tbody tr').each(function() {
                        const qty = parseInt($(this).find('.product-input').val()) || 0;
                        const finalTax = parseFloat($(this).find('[key-id="finalTax"]').text()) || 0;
                        const productDiscount = parseFloat($(this).find('.discount-input').val()) || 0;
                        const subTotalItem = parseFloat($(this).find('[key-id="subtotal"]').text()) || 0;

                        subtotal += subTotalItem;
                        tax += finalTax;
                        discount += productDiscount * qty;
                    });

                    const totalAmount = subtotal + tax;
                    const receivedAmount = parseFloat(this.$receivedAmount.val()) || 0;
                    const change = receivedAmount - totalAmount;

                    $('#subtotal').text(this.formatNumber(subtotal));
                    $('#tax').text(this.formatNumber(tax));
                    $('#discount').text(this.formatNumber(discount));
                    $('#totalAmount').text(this.formatNumber(totalAmount));
                    $('#change-balance').text(this.formatNumber(change));
                },

                removeRow($row) {
                    $row.remove();
                    this.updateSidebar();
                },

                handleRowSelection(event) {
                    if (!$(event.target).is('button, input')) {
                        $('tr').removeClass('selected-row');
                        $(event.currentTarget).addClass('selected-row');
                    }
                },

                formatNumber: (num) => parseFloat(num).toFixed(2),
                calculateSubtotal: (price, qty, discount, tax) => (price * qty) - (discount * qty) + (tax * qty),
            };

            POS.init();

            window.onerror = function(message, source, lineno, colno, error) {
                console.error("An error occurred:", message, "at", source, ":", lineno, ":", colno);
            };
        });
    </script>


    <script>
        $(document).ready(function() {
            // Initialize Select2 for store search
            $("#stationId").select2({
                ajax: {
                    url: "/api/stores/search",
                    dataType: 'json',
                    delay: 250,
                    data: function(params) {
                        return {
                            keyword: params.term
                        };
                    },
                    processResults: function(data) {
                        return {
                            results: $.map(data, function(obj) {
                                return {
                                    id: obj.id,
                                    text: obj.storeName + (obj.counterStore ? ' (Counter Store)' : ''),
                                    counterStore: obj.counterStore
                                };
                            })
                        };
                    }
                },
                minimumInputLength: 1,
                placeholder: 'Search for a store...',
                allowClear: true
            });
        });
    </script>


    <script>
        $(document).ready(function() {
            // Initialize Select2
            $("#supplierId").select2({
                ajax: {
                    url: "/api/suppliers/search",
                    dataType: 'json',
                    delay: 250,
                    data: function(params) {
                        return {
                            keyword: params.term
                        };
                    },
                    processResults: function(data) {
                        console.log(data);
                        return {
                            results: $.map(data, function(obj) {
                                return {
                                    id: obj.id,
                                    value: obj.id,
                                    text: obj.id + ' - ' + obj.creditorName,
                                    supplierId: obj.id // add the supplierId to the option
                                };
                            })
                        };
                    }
                },
                minimumInputLength: 1
            });
        });
    </script>












   <script>
       (function($) {
           'use strict';

           // Create a namespace for our application
           window.StockApp = window.StockApp || {};

           const API_CONFIG = {
               baseUrl: '/api/stocks',
               endpoint: 'purchase'
           };

           const DOM = {
               selectors: {
                   supplier: '#supplierId',
                   station: '#stationId',
                   purchaseOrder: '#purchaseOrder',
                   invoiceNumber: '#invoiceNumber',
                   purchaseDate: '#purchaseDate',
                   productsTable: '#selectedProducts-pos tbody',
                   searchInput: '#search-pos',
                   totals: {
                       subtotal: '#subtotal',
                       tax: '#tax',
                       discount: '#discount',
                       totalAmount: '#totalAmount'
                   }
               }
           };

           const showNotification = (type, message) => {
               $.wnoty({ type, message, position: 'top-right' });
           };

           StockApp.PurchaseTransaction = {
               // Date Handling
               initializeDatePicker: function() {
                   try {
                       const $datePicker = $(DOM.selectors.purchaseDate);
                       const self = this;

                       if ($datePicker.data('datepicker')) {
                           $datePicker.datepicker('destroy');
                       }

                       $datePicker.datepicker({
                           format: 'yyyy-mm-dd',
                           autoclose: true,
                           todayHighlight: true,
                           startDate: moment().subtract(1, 'month').toDate(),
                           endDate: moment().toDate(),
                           clearBtn: true
                       });

                       const today = moment().format('YYYY-MM-DD');
                       $datePicker.datepicker('setDate', today);

                       $datePicker.on('changeDate', function(e) {
                           self.handleDateChange(e);
                       });
                   } catch (error) {
                       console.error('Error initializing datepicker:', error);
                       showNotification('error', 'Error initializing date picker');
                   }
               },

               // Data Collection
               collectFormData: function() {
                   try {
                       const supplierId = $(DOM.selectors.supplier).val();
                       if (!supplierId) throw new Error('Please select a supplier');

                       const branchId = $(DOM.selectors.station).val();
                       if (!branchId) throw new Error('Please select a store location');

                       const purchaseStocks = this.collectProductsData();
                       if (!purchaseStocks.length) throw new Error('Please add at least one product');

                       const purchaseDate = $(DOM.selectors.purchaseDate).val();
                       if (!purchaseDate) throw new Error('Please select a purchase date');

                       const invoiceNumber = $(DOM.selectors.invoiceNumber).val();
                       if (!invoiceNumber) throw new Error('Please enter an invoice number');

                       return {
                           supplierId: parseInt(supplierId),
                           branchId: parseInt(branchId),
                           purchaseStocks,
                           purchaseDate: moment(purchaseDate).format('YYYY-MM-DD'),
                           invoiceNumber: invoiceNumber.trim()
                       };
                   } catch (error) {
                       console.error('Error collecting form data:', error);
                       throw error;
                   }
               },

               collectProductsData: function() {
                   const purchaseStocks = [];

                   try {
                       $(DOM.selectors.productsTable).find('tr').each((_, row) => {
                           const $row = $(row);
                           const quantity = parseInt($row.find('.product-input').val()) || 0;

                           if (quantity <= 0) return;

                           const unitPrice = parseFloat($row.find('.price-input').val()) || 0;
                           const discount = parseFloat($row.find('.discount-input').val() || 0);
                           const subtotal = parseFloat((quantity * unitPrice).toFixed(2));
                           const tax = parseFloat((subtotal * 0.16).toFixed(2)); // 16% VAT

                           purchaseStocks.push({
                               productCode: $row.find('[key-id="productCode"]').text().trim(),
                               productName: $row.find('[key-id="productName"]').text().trim(),
                               unitcost: parseFloat(unitPrice.toFixed(2)),
                               discount: parseFloat(discount.toFixed(2)),
                               tax: tax,
                               subtotal: subtotal,
                               qty: quantity
                           });
                       });
                   } catch (error) {
                       console.error('Error collecting product data:', error);
                       throw error;
                   }

                   return purchaseStocks;
               },

               calculateTotals: function() {
                   try {
                       const products = this.collectProductsData();

                       const subtotal = products.reduce((sum, product) => sum + product.subtotal, 0);
                       const tax = products.reduce((sum, product) => sum + product.tax, 0);
                       const discount = products.reduce((sum, product) => sum + product.discount, 0);
                       const total = subtotal + tax - discount;

                       // Update UI with formatted numbers
                       $(DOM.selectors.totals.subtotal).text(subtotal.toFixed(2));
                       $(DOM.selectors.totals.tax).text(tax.toFixed(2));
                       $(DOM.selectors.totals.discount).text(discount.toFixed(2));
                       $(DOM.selectors.totals.totalAmount).text(total.toFixed(2));
                   } catch (error) {
                       console.error('Error calculating totals:', error);
                   }
               },

               // Validation
               validateFormData: function(data) {
                   const errors = [
                       !data.supplierId && 'Please select a supplier',
                       !data.branchId && 'Please select a store location',
                       (!data.purchaseStocks?.length) && 'Please add at least one product',
                       !data.purchaseDate && 'Please select a purchase date',
                       !data.invoiceNumber && 'Please enter an invoice number',
                       ...this.validateProducts(data.purchaseStocks)
                   ].filter(Boolean);

                   if (errors.length) throw new Error(errors[0]);
                   return true;
               },

               validateProducts: function(products = []) {
                   return products.reduce((errors, product) => {
                       if (!product.productCode) errors.push('Invalid product information detected');
                       if (!product.qty || product.qty <= 0)
                           errors.push('All products must have a valid quantity');
                       if (!product.unitcost || product.unitcost < 0)
                           errors.push('All products must have a valid unit cost');
                       return errors;
                   }, []);
               },

               // API Calls
               savePurchase: async function(data) {
                   try {
                       console.log("Purchase Stock Data:", JSON.stringify(data));

                       const response = await fetch(`${API_CONFIG.baseUrl}/${API_CONFIG.endpoint}`, {
                           method: 'POST',
                           headers: {
                               'Content-Type': 'application/json',
                               'Accept': 'application/json'
                           },
                           body: JSON.stringify(data)
                       });

                       if (!response.ok) {
                           let errorMessage;
                           try {
                               const errorData = await response.json();
                               errorMessage = errorData.message || `Server error: ${response.status}`;
                           } catch (e) {
                               errorMessage = await response.text();
                           }
                           throw new Error(errorMessage);
                       }

                       const responseText = await response.text();
                       if (!responseText) {
                           return { success: true };
                       }

                       try {
                           return JSON.parse(responseText);
                       } catch (e) {
                           return { success: true, message: responseText };
                       }
                   } catch (error) {
                       console.error('Save error:', error);
                       throw error;
                   }
               },

               // UI Updates
               toggleLoadingState: function(button, isLoading) {
                   const $button = $(button);
                   const $icon = $button.find('i');

                   $icon
                       .toggleClass('fa-shopping-cart', !isLoading)
                       .toggleClass('fa-spinner fa-spin', isLoading);

                   $button.prop('disabled', isLoading);
               },

               updateTotals: function() {
                   try {
                       Object.values(DOM.selectors.totals).forEach(selector =>
                           $(selector).text('0.00')
                       );
                   } catch (error) {
                       console.error('Error updating totals:', error);
                   }
               },

               clearForm: function() {
                   try {
                       $(DOM.selectors.supplier).val('').trigger('change');
                       $(DOM.selectors.station).val('').trigger('change');
                       $(DOM.selectors.purchaseOrder).val('');
                       $(DOM.selectors.invoiceNumber).val('');

                       const today = moment().format('YYYY-MM-DD');
                       $(DOM.selectors.purchaseDate).datepicker('setDate', today);

                       $(DOM.selectors.productsTable).empty();
                       $(DOM.selectors.searchInput).val('');

                       this.updateTotals();

                       $(document).trigger('purchaseTransactionFormCleared');
                   } catch (error) {
                       console.error('Error clearing form:', error);
                       showNotification('error', 'Error clearing form');
                   }
               },

               // Event Handlers
               handleSubmit: async function(event) {
                   event.preventDefault();
                   const button = event.currentTarget;

                   try {
                       this.toggleLoadingState(button, true);

                       const formData = this.collectFormData();
                       this.validateFormData(formData);

                       await this.savePurchase(formData);

                       showNotification('success', 'Purchase transaction saved successfully!');
                       this.clearForm();

                       $(document).trigger('purchaseTransactionSaved');
                       $(document).trigger('purchaseTransactionTableCleared');

                   } catch (error) {
                       showNotification('error', error.message || 'An error occurred while saving the purchase');
                       console.error(error);
                   } finally {
                       this.toggleLoadingState(button, false);
                   }
               },

               handleCancel: function(event) {
                   event.preventDefault();
                   const hasChanges = $(DOM.selectors.productsTable).find('tr').length > 0;
                   if (!hasChanges || confirm('Are you sure? Unsaved changes will be lost.')) {
                       this.clearForm();
                   }
               },

               handleStationChange: function() {
                   if ($(DOM.selectors.station).val()) {
                       $(DOM.selectors.productsTable).empty();
                       this.updateTotals();
                       $(document).trigger('stationChanged');
                   }
               },

               handleSupplierChange: function() {
                   if ($(DOM.selectors.supplier).val()) {
                       console.log('Supplier changed');
                       $(document).trigger('supplierChanged');
                   }
               },

               handleDateChange: function(e) {
                   const selectedDate = $(e.target).val();
                   if (!moment(selectedDate, 'YYYY-MM-DD', true).isValid()) {
                       showNotification('error', 'Please select a valid date');
                       $(e.target).datepicker('setDate', moment().format('YYYY-MM-DD'));
                   }
               },

               handleProductChange: function() {
                   this.calculateTotals();
                   $(document).trigger('productsChanged');
               },

               init: function() {
                   try {
                       const self = this;

                       this.initializeDatePicker();

                       $('#btnSaveAsPurchase').off('click').on('click', function(e) {
                           self.handleSubmit.call(self, e);
                       });

                       $('#btnCancel').off('click').on('click', function(e) {
                           self.handleCancel.call(self, e);
                       });

                       $(DOM.selectors.station).off('change').on('change', function() {
                           self.handleStationChange.call(self);
                       });

                       $(DOM.selectors.supplier).off('change').on('change', function() {
                           self.handleSupplierChange.call(self);
                       });

                       const $productsTable = $(DOM.selectors.productsTable);
                       $productsTable.off('change', '.product-input, .price-input, .discount-input')
                           .on('change', '.product-input, .price-input, .discount-input',
                               function() {
                                   self.handleProductChange.call(self);
                               });

                       $('[data-toggle="tooltip"]').tooltip();

                       console.log('Purchase Transaction module initialized successfully');
                   } catch (error) {
                       console.error('Error initializing Purchase Transaction module:', error);
                       showNotification('error', 'Error initializing form');
                   }
               },

               destroy: function() {
                   try {
                       const $datePicker = $(DOM.selectors.purchaseDate);
                       if ($datePicker.data('datepicker')) {
                           $datePicker.datepicker('destroy');
                       }

                       $('#btnSaveAsPurchase').off('click');
                       $('#btnCancel').off('click');
                       $(DOM.selectors.station).off('change');
                       $(DOM.selectors.supplier).off('change');
                       $(DOM.selectors.productsTable).off('change');

                       $('[data-toggle="tooltip"]').tooltip('dispose');

                       console.log('Purchase Transaction module destroyed successfully');
                   } catch (error) {
                       console.error('Error destroying Purchase Transaction module:', error);
                   }
               }
           };

           // Initialize when document is ready
           $(document).ready(function() {
               if (StockApp.PurchaseTransaction.destroy) {
                   StockApp.PurchaseTransaction.destroy();
               }
               StockApp.PurchaseTransaction.init();
           });

       })(jQuery);
   </script>
</div>






