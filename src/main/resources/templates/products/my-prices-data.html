<div th:fragment="products">
    <div class="row">
        <div class="col-md-12">
            <div class="card p-4">
                <div id="table_div_content"></div>
            </div>
        </div>
    </div>

    <script>
        ($ => {
            // Configuration
            const config = {
                defaultApiUrl: '/api-bulk/products-database',
                recordsPerPageOptions: [10, 20, 50, 100, 'All'],
                defaultRecordsPerPage: 10,
                exportFileName: 'Price Lists Report'
            };

            // State management
            const state = {
                fullData: [],
                currentPage: 1,
                totalPages: 0,
                totalRecords: 0,
                filteredData: [],
                recordsPerPage: config.defaultRecordsPerPage
            };

            // Initialize the page
            const initializePage = () => {
                const $target = $('#table_div_content');
                $target.empty();

                // Create search input and records per page dropdown container
                const $controlsContainer = $('<div>').addClass('d-flex justify-content-between align-items-center mb-3');
                const $searchInput = $('<input>')
                    .attr({
                        type: 'text',
                        placeholder: 'Search products...',
                        id: 'searchInput'
                    })
                    .addClass('form-control form-control-sm')
                    .on('input', e => filterTable(e.target.value));

                // Create records per page dropdown
                const $recordsPerPageWrapper = $('<div>').addClass('records-per-page-wrapper');
                const $recordsPerPage = $('<select>').addClass('form-control form-control-sm records-per-page');
                config.recordsPerPageOptions.forEach(option => {
                    const $option = $('<option>').val(option === 'All' ? -1 : option).text(option);
                    if (option === state.recordsPerPage) {
                        $option.prop('selected', true);
                    }
                    $recordsPerPage.append($option);
                });
                $recordsPerPage.on('change', (e) => {
                    state.recordsPerPage = e.target.value === '-1' ? state.filteredData.length : parseInt(e.target.value);
                    state.currentPage = 1;
                    changePage(1);
                });
                $recordsPerPageWrapper.append([
                    $('<label>').text('Records per page: ').addClass('mr-2'),
                    $recordsPerPage
                ]);

                $controlsContainer.append([$searchInput, $recordsPerPageWrapper]);
                $target.append($controlsContainer);

                // Create table wrapper
                const $tableWrapper = $('<div>').attr('id', 'tableWrapper').addClass('table-responsive');
                $target.append($tableWrapper);

                // Create loading overlay
                const $loadingOverlay = $('<div>')
                    .attr('id', 'loading-overlay')
                    .html('<div class="spinner-border text-primary" role="status"><span class="sr-only">Loading...</span></div>')
                    .hide();
                $('body').append($loadingOverlay);

                applyStyles();
                fetchAndDisplayData();
            };

            // Generate dynamic table
            const generateDynamicTable = (data) => {
                const $tableWrapper = $('#tableWrapper');
                $tableWrapper.empty();

                // Add export buttons
                const $buttonGroup = $('<div>').addClass('btn-group mb-3');
                $buttonGroup.append([
                    createButton('Excel', 'fas fa-file-excel', 'btn-success', () => exportToExcel()),
                    createButton('PDF', 'fas fa-file-pdf', 'btn-danger', () => downloadPDF())
                ]);
                $tableWrapper.append($buttonGroup);

                if (!Array.isArray(data) || data.length === 0) {
                    $tableWrapper.append('<p class="text-muted">No data available</p>');
                    return;
                }

                const headers = [...new Set(data.flatMap(Object.keys))];
                const $table = $('<table>').addClass('dynamic-table table-striped');
                const $thead = $('<thead>').appendTo($table);
                const $tbody = $('<tbody>').appendTo($table);

                const $headerRow = $('<tr>');
                headers.forEach(h => $headerRow.append($('<th>').text(h.charAt(0).toUpperCase() + h.slice(1).replace(/_/g, ' '))));
                $headerRow.appendTo($thead);

                data.forEach((row, index) => {
                    const $dataRow = $('<tr>');
                    headers.forEach(h => {
                        const val = row[h];
                        $dataRow.append($('<td>').text(val !== null && val !== undefined ? val : 'N/A'));
                    });
                    $dataRow.appendTo($tbody);
                });

                $tableWrapper.append($table);

                // Add pagination
                const $pagination = generatePagination();
                $tableWrapper.append($pagination);
            };

            // Generate pagination
            const generatePagination = () => {
                const totalPages = state.recordsPerPage === -1 ? 1 : Math.ceil(state.filteredData.length / state.recordsPerPage);
                state.totalPages = totalPages;
                const start = (state.currentPage - 1) * state.recordsPerPage + 1;
                const end = state.recordsPerPage === -1 ? state.filteredData.length : Math.min(state.currentPage * state.recordsPerPage, state.filteredData.length);

                const $pagination = $('<nav>').addClass('pagination-wrapper mt-3');
                const $ul = $('<ul>').addClass('pagination pagination-sm justify-content-center mb-2');

                // Previous button
                $ul.append(
                    $('<li>').addClass(`page-item ${state.currentPage === 1 ? 'disabled' : ''}`)
                        .append($('<a>').addClass('page-link').text('Previous').on('click', () => changePage(state.currentPage - 1)))
                );

                // Page numbers
                const maxPages = 5;
                let startPage = Math.max(1, state.currentPage - Math.floor(maxPages / 2));
                let endPage = Math.min(totalPages, startPage + maxPages - 1);

                if (endPage - startPage < maxPages - 1) {
                    startPage = Math.max(1, endPage - maxPages + 1);
                }

                for (let i = startPage; i <= endPage; i++) {
                    $ul.append(
                        $('<li>').addClass(`page-item ${i === state.currentPage ? 'active' : ''}`)
                            .append($('<a>').addClass('page-link').text(i).on('click', () => changePage(i)))
                    );
                }

                // Next button
                $ul.append(
                    $('<li>').addClass(`page-item ${state.currentPage === totalPages ? 'disabled' : ''}`)
                        .append($('<a>').addClass('page-link').text('Next').on('click', () => changePage(state.currentPage + 1)))
                );

                $pagination.append($ul);

                // Pagination info
                const $info = $('<div>').addClass('text-center text-muted small')
                    .html(`Page ${state.currentPage} of ${totalPages} | Showing ${start}-${end} of ${state.filteredData.length} records (${state.totalRecords} total)`);
                $pagination.append($info);

                return $pagination;
            };

            // Change page
            const changePage = (newPage) => {
                const totalPages = state.recordsPerPage === -1 ? 1 : Math.ceil(state.filteredData.length / state.recordsPerPage);
                if (newPage < 1 || newPage > totalPages) return;

                state.currentPage = newPage;
                const start = (state.currentPage - 1) * state.recordsPerPage;
                const end = state.recordsPerPage === -1 ? state.filteredData.length : start + state.recordsPerPage;
                const pageData = state.filteredData.slice(start, end);

                generateDynamicTable(pageData);
            };

            // Filter table
            const filterTable = (searchTerm) => {
                state.filteredData = state.fullData.filter(row =>
                    Object.values(row).some(value =>
                        String(value).toLowerCase().includes(searchTerm.toLowerCase())
                    )
                );
                state.currentPage = 1;
                changePage(1);
            };

            // Fetch and display data
            const fetchAndDisplayData = (apiUrl = config.defaultApiUrl) => {
                $('#tableWrapper').html('<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</div>');

                $.ajax({
                    url: apiUrl,
                    method: 'GET',
                    dataType: 'json',
                    success: data => {
                        state.fullData = data;
                        state.totalRecords = data.length;
                        state.filteredData = [...data];
                        changePage(1);
                    },
                    error: (_, textStatus, errorThrown) => {
                        console.error('Error fetching data:', textStatus, errorThrown);
                        $('#tableWrapper').html('<div class="alert alert-danger">Error loading data. Please try again later.</div>');
                    }
                });
            };

            // Export functions
            const exportToExcel = () => {
                generateExcel(state.filteredData, config.exportFileName);
            };

            const downloadPDF = () => {
                printGeneratePdf(state.filteredData, config.exportFileName);
            };

            // Helper function to create buttons
            const createButton = (text, icon, className, action) => {
                return $('<button>').addClass(`btn ${className} btn-sm`)
                    .html(`<i class="${icon} mr-1"></i>${text}`)
                    .on('click', action);
            };

            // Apply styles
            const applyStyles = () => {
                $('head').append(`
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap');
                        @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css');

                        .dynamic-table {
                            width: 100%;
                            border-collapse: separate;
                            border-spacing: 0;
                            font-family: 'Roboto', sans-serif;
                            font-size: 12px;
                            background-color: #fff;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                            border-radius: 8px;
                            overflow: hidden;
                        }
                        .dynamic-table th {
                            background-color: #4a90e2;
                            color: #fff;
                            font-weight: 600;
                            text-transform: uppercase;
                            padding: 12px 16px;
                            vertical-align: middle;
                            border-bottom: 2px solid #dee2e6;
                        }
                        .dynamic-table td {
                            padding: 10px 16px;
                            vertical-align: middle;
                            border-bottom: 1px solid #e9ecef;
                            color: #333;
                        }
                        .dynamic-table.table-striped tbody tr:nth-of-type(odd) {
                            background-color: rgba(0,0,0,0.02);
                        }
                        .dynamic-table tr:hover {
                            background-color: #f8f9fa;
                        }
                        .table-responsive {
                            overflow-x: auto;
                            -webkit-overflow-scrolling: touch;
                            margin-bottom: 1rem;
                            border-radius: 8px;
                        }
                        .btn-group {
                            display: flex;
                            gap: 5px;
                        }
                        .btn-group .btn {
                            border-radius: 4px;
                            padding: 8px 12px;
                            transition: all 0.2s ease;
                        }
                        .btn-group .btn:hover {
                            transform: translateY(-2px);
                        }
                        .pagination-wrapper {
                            background: #f8f9fa;
                            padding: 10px;
                            border-radius: 6px;
                            margin-top: 15px;
                        }
                        .pagination .page-link {
                            padding: 6px 12px;
                            font-size: 12px;
                            border-radius: 4px;
                            color: #4a90e2;
                            background-color: #fff;
                            border: 1px solid #dee2e6;
                            min-width: 32px;
                            text-align: center;
                            transition: all 0.2s ease;
                        }
                        .pagination .page-item.active .page-link {
                            background-color: #4a90e2;
                            border-color: #4a90e2;
                            color: #fff;
                            font-weight: 600;
                        }
                        .pagination .page-item.disabled .page-link {
                            background-color: #e9ecef;
                            border-color: #dee2e6;
                            color: #6c757d;
                        }
                        .pagination .page-item:not(.active):not(.disabled) .page-link:hover {
                            background-color: #4a90e2;
                            color: #fff;
                            border-color: #4a90e2;
                        }
                        #searchInput {
                            width: 100%;
                            max-width: 300px;
                            border-radius: 4px;
                            border: 1px solid #ced4da;
                            padding: 8px;
                        }
                        .records-per-page-wrapper {
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        }
                        .records-per-page {
                            width: auto;
                            max-width: 100px;
                            border-radius: 4px;
                            padding: 6px;
                        }
                        .text-muted {
                            font-size: 12px;
                        }
                        #loading-overlay {
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(255, 255, 255, 0.9);
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            z-index: 9999;
                        }
                        @media print {
                            .btn-group, #searchInput, .pagination-wrapper, .records-per-page-wrapper {
                                display: none;
                            }
                            .dynamic-table {
                                font-size: 10px;
                                box-shadow: none;
                            }
                            .dynamic-table th {
                                background-color: #f8f9fa !important;
                                color: #000 !important;
                                border: 1px solid #dee2e6 !important;
                            }
                            .dynamic-table td {
                                border: 1px solid #dee2e6 !important;
                            }
                        }
                    </style>
                `);
            };

            // Initialize
            $(() => initializePage());
        })(jQuery);
    </script>
</div>