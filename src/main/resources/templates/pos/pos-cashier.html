<div th:fragment="members">


    <style type="text/css">


        /* Set flexbox for the pos-container */
        .pos-container {
            display: flex;
            flex-direction: column;
            height: auto;

        }

        /* Set flex for pos-content */
        .pos-content {
            display: flex;
            flex: 1;
        }

        /* Style pos-content-container */
        .pos-content-container {
            flex: 1;
            padding: 10px;
        }

        /* Style pos-sidebar */
        .pos-sidebar {

            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            position: sticky;
            top: 0;
            height: auto;
            display: flex;
            flex-direction: column;

        }
    </style>


    <div class="panel panel flex-1 m-0 d-flex flex-column overflow-hidden rounded border">
        <div class="panel-heading bg-light-100 border-bottom">
            <h4 class="panel-title">Bills:</h4>
            <div class="panel-heading-btn">
                <a href="javascript:;" class="btn btn-xs btn-icon btn-default" data-toggle="panel-expand"><i class="fa fa-expand"></i></a>
                <a href="javascript:;" class="btn btn-xs btn-icon btn-success" data-toggle="panel-reload"><i class="fa fa-redo"></i></a>
                <a href="javascript:;" class="btn btn-xs btn-icon btn-warning" data-toggle="panel-collapse"><i class="fa fa-minus"></i></a>
                <a href="javascript:;" class="btn btn-xs btn-icon btn-danger" data-toggle="panel-remove"><i class="fa fa-times"></i></a>
            </div>
        </div>


        <div class="panel panel flex-1 m-0 d-flex flex-column overflow-hidden">

            <div class="panel-body p-2 flex-1 overflow-hidden">

                <div class="pos-container">

                    <!-- pos-content -->
                    <div class="pos-content">
                        <div class="col-md-9">
                            <!-- pos-content-container -->
                            <div class="pos-content-container">

                                <div class="card">
                                    <div class="card-header h6 bg-none p-2 d-flex align-items-center">
                                        <div class="flex-1">
                                            <i class="fa fa-chalkboard-user fa-fw text-dark me-1"></i>Billed Services:
                                        </div>

                                    </div>


                                    <div class="card-body fw-bold">
                                        <div class="row" id="cashBillContainer">

                                        </div>
                                    </div>
                                </div>



                            </div>
                            <!-- END pos-content-container -->
                        </div>
                        <!-- pos-sidebar -->
                        <div class="col-md-3">

                            <div class="pos-sidebar bg-gradient">

                                <div class="pos-sidebar-body" >

                                    <div class="card rounded border">
                                        <div class="card-header h6 mb-0 bg-none p-3">
                                            OSCU Status: <a href="#" class="ms-auto text-decoration-none text-black-500">
                                            <i class="fa fa-fw fa-lg fs-12px me-2 connectivity-icon"></i>
                                            <span class="status-text"></span>
                                            <span class="status-value" id="customer-id" style="display: none;"></span>
                                        </a>
                                        </div>
                                        <div class="card-body">
                                            <div class="d-flex align-items-center bg-light rounded p-2 mb-2">
                                                <div class="me-3">
                                                    <i class="fab fa-cc-amazon-pay fa-3x text-dark"></i>
                                                </div>
                                                <div class="flex-grow-1 text-end">
                                                    <span id="totalAmount" class="fs-1 fw-bold">0.00</span>
                                                </div>
                                            </div>
                                            <div class="form-floating mb-15px">
                                                <input type="text" name="receivedAmount" class="form-control h-45px fs-13px" placeholder="Amount Paid {0.00}" id="receivedAmount"/>
                                                <label for="receivedAmount" class="d-flex align-items-center fs-13px text-gray-600">Amount Paid</label>
                                            </div>
                                            <div class="row mb-2">
                                                <div class="col-md-12 pt-2">
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input" type="checkbox" id="inlineCheckbox1" value="CASH" checked>
                                                        <label class="form-check-label" for="inlineCheckbox1">CASH</label>
                                                    </div>
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input" type="checkbox" id="inlineCheckbox2" value="MPESA">
                                                        <label class="form-check-label" for="inlineCheckbox2">MPESA</label>
                                                    </div>
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input" type="checkbox" id="inlineCheckbox3" value="VISA">
                                                        <label class="form-check-label" for="inlineCheckbox3">VISA</label>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>


                                    </div>


                                </div>

                                <div class="pos-sidebar-footer" style="padding: 5px; border-top: 1px solid #e5e5e5;">

                                    <div class="card rounded border">
                                        <div class="card-header bg-none p-3 h6 m-0 d-flex align-items-center">
                                            <i class="fa fa-credit-card fa-lg me-2 text-black-500"></i>
                                            Payment Records
                                            <a href="#" class="ms-auto text-decoration-none text-black-500"><i class="fab fa-paypal me-1 fa-lg"></i> View paypal records</a>
                                        </div>
                                        <div class="card-body">
                                            <table class="table table-borderless table-sm fw-bold m-0">
                                                <tbody>
                                                <tr>
                                                    <td class="w-150px">Total</td>
                                                    <td>3 items</td>
                                                    <td class="text-end" id="subtotal"><b>0.00</b></td>
                                                </tr>
                                                <tr>
                                                    <td>Tax</td>
                                                    <td>VAT 16%</td>
                                                    <td class="text-end" id="tax"><b>0.00</b></td>
                                                </tr>


                                                <tr>
                                                    <td class="pb-2" colspan="2"><b>Change</b></td>
                                                    <td class="text-end pb-2 text-decoration-underline" id="change-balance"><b>0.00</b></td>
                                                </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="card-footer bg-none d-flex p-3">

                                            <div class="row">
                                                <div class="col-6">
                                                    <a href="#" class="btn btn-danger ms-auto rounded-3 text-center me-50px" style="width: 100%;">
                                                        <i class="fab fa-paypal d-block fs-18px my-1"></i>
                                                        CANCEL
                                                    </a>
                                                </div>
                                                <div class="col-6">
                                                    <a href="#" id="saveSaleTransactionBtn" class="btn btn-success ms-auto rounded-3 text-center me-50px" style="width: 100%;">
                                                        <i class="fab fa-cc-visa d-block fs-18px my-1"></i>
                                                        MARK PAID
                                                    </a>
                                                </div>
                                            </div>



                                        </div>
                                    </div>

                                </div>


                            </div>
                        </div>


                        <!-- END pos-sidebar -->

                    </div>
                    <!-- END pos-content -->

                </div>

            </div>
        </div>



    </div>


    <script>
        // Initialize Select2 and handle transaction search
        $('#searchBySerialNumber').select2({
            width: '300px',
            placeholder: 'Search by serial number...',
            minimumInputLength: 2,
            allowClear: true,
            ajax: {
                url: '/api/products-manager/search-sales-transactions',
                dataType: 'json',
                delay: 250,
                data: function(params) {
                    return {
                        serialNumber: params.term
                    };
                },
                processResults: function(data) {
                    return {
                        results: data.map(transaction => ({
                            id: transaction.serial_number,
                            text: transaction.serial_number,
                            transaction: transaction
                        }))
                    };
                },
                cache: true
            }
        }).on('select2:select', function(e) {
            const selectedTransaction = e.params.data.transaction;
            displayTransactionSummary(selectedTransaction);
            updateCashBillData(selectedTransaction.serial_number);  // Added this line back
        }).on('select2:clear', function() {
            $('#transactionSummaryContainer').empty();
        });

        // Format date helper function
        const formatDate = (dateString) => {
            if (!dateString) return '';
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        };

        // Format currency helper function
        const formatCurrency = (amount) => {
            if (!amount) return '0.00';
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        };

        // Display transaction summary
        const displayTransactionSummary = (transaction) => {
            const deepBlue = '#0047AB';
            const deepRed = 'rgba(245,13,55,0.98)';
            const iconStyles = 'margin-right: 5px; vertical-align: middle;';

            const summaryHtml = `
        <div id="transactionSummaryContainer" style="font-family: Arial, sans-serif;">
            <p style="margin: 0; font-size: 11px; line-height: 1.6;">
                <span id="currentSerial" style="color: ${deepRed}; font-weight: bold;">
                    <i class="fas fa-file-invoice" style="${iconStyles}"></i>${transaction.serial_number}
                </span>
                <span style="color: black;">
                    <i class="fas fa-calendar" style="${iconStyles}"></i>Date: ${formatDate(transaction.transaction_date)}
                </span>
                <span style="color: ${deepBlue};">
                    <i class="fas fa-user" style="${iconStyles}"></i>Created by: ${transaction.created_by}
                </span>
                <span style="color: black;">
                    <i class="fas fa-money-bill" style="${iconStyles}"></i>Amount: ${formatCurrency(transaction.total_amount)}
                </span>
            </p>
        </div>
    `;

            $('#transactionSummaryContainer').html(summaryHtml);
        };
    </script>






    <script>
        function updateCashBillData(serialNumber) {
            // Sample data structure that would normally come from API

            // Create the table structure
            const tableStructure = `
        <div id="alertContainer"></div>
        <div class="table-responsive panel-heading bg-light-100">
            <table id="cash-bill-table" class="table table-bordered mb-0">
                <thead class="bg-light-100">
                    <tr>
                        <th><input type="checkbox" id="select-all-checkbox"></th>
                        <th>No</th>
                        <th>Product ID</th>
                        <th>Product Code</th>
                        <th>Product Name</th>
                        <th class="text-end">Quantity</th>
                        <th class="text-end">Unit Price</th>
                        <th class="text-end">Tax</th>
                        <th class="text-end">Net Tax</th>
                        <th class="text-end">Subtotal</th>
                    </tr>
                </thead>
                <tbody></tbody>
                <tfoot></tfoot>
            </table>
        </div>
    `;

            // Add custom styles
            const styles = `
        <style id="custom-bill-manager-style">
            #cash-bill-table {
                font-size: 0.7rem;
            }
            #cash-bill-table th,
            #cash-bill-table td {
                padding: 0.3rem;
            }
            #cash-bill-table .text-end {
                text-align: right;
            }
            .table-responsive {
                max-height: 500px;
                overflow-y: auto;
            }
        </style>
    `;

            // Insert the structure and styles
            document.getElementById('cashBillContainer').innerHTML = styles + tableStructure;

            // Function to display the data
            function displayData(data) {
                const tbody = document.querySelector('#cash-bill-table tbody');
                const tfoot = document.querySelector('#cash-bill-table tfoot');

                // Clear existing content
                tbody.innerHTML = '';

                // Calculate totals
                let totalItems = 0;
                let totalAmount = 0;
                let totalTax = 0;

                // Add rows
                data.forEach((item, index) => {
                    totalItems += item.qty;
                    totalAmount += item.subtotal;
                    totalTax += item.net_tax;

                    const row = `
                <tr>
                    <td><input type="checkbox" class="row-checkbox" data-product-id="${item.product_id}"></td>
                    <td>${index + 1}</td>
                    <td>${item.product_id}</td>
                    <td>${item.product_code}</td>
                    <td>${item.product_name}</td>
                    <td class="text-end">${item.qty}</td>
                    <td class="text-end">${item.unitprice.toFixed(2)}</td>
                    <td class="text-end">${item.tax.toFixed(2)}</td>
                    <td class="text-end">${item.net_tax.toFixed(2)}</td>
                    <td class="text-end">${item.subtotal.toFixed(2)}</td>
                </tr>
            `;
                    tbody.insertAdjacentHTML('beforeend', row);
                });

                // Add footer with totals
                const footerRow = `
            <tr class="table-light">
                <td colspan="5"><strong>Total Items: ${totalItems}</strong></td>
                <td colspan="3" class="text-end"><strong>Total Tax: ${totalTax.toFixed(2)}</strong></td>
                <td colspan="2" class="text-end"><strong>Total Amount: ${totalAmount.toFixed(2)}</strong></td>
            </tr>
        `;
                tfoot.innerHTML = footerRow;

                // Update sidebar if it exists
                updateSidebar(totalItems, totalAmount, totalTax);

                // Add event listeners
                setupEventListeners();
            }

            // Function to update sidebar
            function updateSidebar(totalItems, totalAmount, totalTax) {
                // Update items count if element exists
                const itemsElement = document.querySelector('.table-borderless tr:first-child td:nth-child(2)');
                if (itemsElement) itemsElement.textContent = `${totalItems} items`;

                // Update subtotal if element exists
                const subtotalElement = document.querySelector('#subtotal b');
                if (subtotalElement) subtotalElement.textContent = totalAmount.toFixed(2);

                // Update tax if element exists
                const taxElement = document.querySelector('#tax b');
                if (taxElement) taxElement.textContent = totalTax.toFixed(2);

                // Update total amount if element exists
                const totalElement = document.querySelector('#totalAmount');
                if (totalElement) totalElement.textContent = totalAmount.toFixed(2);

                // Update change if received amount input exists
                updateChange(totalAmount);
            }

            // Function to update change amount
            function updateChange(totalAmount) {
                const receivedInput = document.querySelector('#receivedAmount');
                const changeElement = document.querySelector('#change-balance b');

                if (receivedInput && changeElement) {
                    const receivedAmount = parseFloat(receivedInput.value) || 0;
                    const change = receivedAmount - totalAmount;
                    changeElement.textContent = change >= 0 ? change.toFixed(2) : '0.00';
                }
            }

            // Function to setup event listeners
            function setupEventListeners() {
                // Select all checkbox
                const selectAllCheckbox = document.querySelector('#select-all-checkbox');
                const rowCheckboxes = document.querySelectorAll('.row-checkbox');

                if (selectAllCheckbox) {
                    selectAllCheckbox.addEventListener('change', (e) => {
                        rowCheckboxes.forEach(checkbox => checkbox.checked = e.target.checked);
                    });
                }

                // Individual checkboxes
                rowCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        if (selectAllCheckbox) {
                            selectAllCheckbox.checked =
                                Array.from(rowCheckboxes).every(cb => cb.checked);
                        }
                    });
                });

                // Received amount input
                const receivedInput = document.querySelector('#receivedAmount');
                if (receivedInput) {
                    receivedInput.addEventListener('input', () => {
                        const totalAmount = parseFloat(document.querySelector('#totalAmount')?.textContent || '0');
                        updateChange(totalAmount);
                    });
                }
            }

            // If serialNumber is provided, fetch data from API
            if (serialNumber) {
                fetch(`/api/products-manager/order-transaction-details/${serialNumber}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.length === 0) {
                            document.querySelector('#alertContainer').innerHTML = `
                        <div class="alert alert-info" role="alert">
                            No records found for this transaction.
                        </div>
                    `;
                            document.querySelector('.table-responsive').style.display = 'none';
                        } else {
                            displayData(data);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching cash bill data:', error);
                        document.querySelector('#alertContainer').innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        Error loading cash bill data. Please try again later.
                    </div>
                `;
                        document.querySelector('.table-responsive').style.display = 'none';
                    });
            }
        }
    </script>










    <script>
        // Simplified Payment Processing Module
        const PaymentProcessor = (function() {
            function getSelectedPaymentModes() {
                return ['CASH', 'MPESA', 'VISA'].filter(mode =>
                    $(`#inlineCheckbox${mode === 'CASH' ? '1' : mode === 'MPESA' ? '2' : '3'}`).is(':checked')
                );
            }

            function getPaymentData() {
                const totalAmount = parseFloat($('#totalAmount').text()) || 0;
                const receivedAmount = parseFloat($('#receivedAmount').val()) || 0;
                const selectedModes = getSelectedPaymentModes();

                const paymentData = {
                    totalAmount: totalAmount,
                    receivedAmount: receivedAmount,
                    paymentModes: selectedModes
                };

                console.log('Payment Data:', paymentData);
                return paymentData;
            }

            function validatePayment(paymentData) {
                if (paymentData.totalAmount <= 0) {
                    showNotification('error', 'Total amount must be greater than zero');
                    return false;
                }

                if (paymentData.receivedAmount <= 0) {
                    showNotification('error', 'Received amount must be greater than zero');
                    return false;
                }

                if (paymentData.paymentModes.length === 0) {
                    showNotification('error', 'Please select at least one payment mode');
                    return false;
                }

                // New validation logic
                if (paymentData.paymentModes.length === 1) {
                    if (paymentData.receivedAmount !== paymentData.totalAmount) {
                        showNotification('error', 'Received amount must be equal to total amount when using a single payment mode');
                        return false;
                    }
                } /*else {
                    if (paymentData.receivedAmount < paymentData.totalAmount) {
                        showNotification('error', 'Received amount cannot be less than total amount');
                        return false;
                    }
                }*/

                return true;
            }

            return {
                getPaymentData: getPaymentData,
                validatePayment: validatePayment
            };
        })();

        // Function to save the sale transaction
        const saveSaleTransaction = async () => {
            const paymentData = PaymentProcessor.getPaymentData();
            console.log('Payment Data before sending:', paymentData);

            if (!PaymentProcessor.validatePayment(paymentData)) {
                return;
            }

            showLoading();
            try {
                const serialNumber = $('#currentSerial').text().trim();

                if (!serialNumber) {
                    showNotification('error', 'Serial number is missing');
                    return;
                }

                const saleTransactionData = {
                    serialNumber: serialNumber,
                    ...paymentData,
                    description: 'Sale transaction'
                };

                console.log('Data to be sent:', saleTransactionData);
                const response = await $.ajax({
                    url: '/api/transactions/sale',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(saleTransactionData)
                });
                console.log('Sale transaction response:', response);
                if (Array.isArray(response) && response.length > 0) {
                    showNotification('success', 'Sale transaction saved successfully');
                    clearInputsAndResetUI();
                } else {
                    showNotification('error', 'No transactions were saved. Please check the server logs.');
                }
            } catch (error) {
                console.error('Error saving sale transaction:', error);
                showNotification('error', 'Error saving sale transaction: ' + (error.responseText || error.message));
            } finally {
                hideLoading();
            }
        };

        // Function to clear inputs and reset UI
        function clearInputsAndResetUI() {
            // Clear and reset input fields
            $('#receivedAmount').val('0.00');
            $('#totalAmount').text('0.00');

            // Uncheck all payment mode checkboxes
            $('#inlineCheckbox1, #inlineCheckbox2, #inlineCheckbox3').prop('checked', false);

            // Clear the cash bill table
            $('#cash-bill-table tbody').empty();


        }


        function showNotification(type, message) {
            $.wnoty({
                type: type,
                message: message,
                position: 'top-right'
            });
        }

        // Attach event listener to the save button
        $('#saveSaleTransactionBtn').on('click', saveSaleTransaction);
    </script>



</div>







