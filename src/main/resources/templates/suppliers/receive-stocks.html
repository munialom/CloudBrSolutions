<div th:fragment="student">
    <div class="col-md-12">

        <!-- BEGIN panel -->
        <div class="panel text-black rounded border" data-sortable-id="index-6">
            <div class="panel-heading bg-light-200 border-bottom">
                <h4 class="panel-title">Purchases Management</h4>
                <div class="panel-heading-btn">
                    <a href="javascript:;" class="btn btn-xs btn-icon btn-default" data-toggle="panel-expand"><i class="fa fa-expand"></i></a>
                    <a href="javascript:;" class="btn btn-xs btn-icon btn-success" data-toggle="panel-reload"><i class="fa fa-redo"></i></a>
                    <a href="javascript:;" class="btn btn-xs btn-icon btn-warning" data-toggle="panel-collapse"><i class="fa fa-minus"></i></a>
                    <a href="javascript:;" class="btn btn-xs btn-icon btn-danger" data-toggle="panel-remove"><i class="fa fa-times"></i></a>
                </div>
            </div>



            <div class="panel-toolbar border rounded bg-white">
                <div class="row">

                    <div class="col-md-6">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="supplierId" class="form-label">Supplier:</label>
                                    <div class="input-group">
                                        <select id="supplierId" name="supplierId" class="form-select form-select-sm">
                                            <option value="">Select Supplier</option>
                                            <!-- Options for suppliers will be dynamically added here -->
                                        </select>
                                        <button class="btn btn-secondary btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#supplierModal">
                                            <i class="fa fa-plus-circle"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="stationId" class="form-label">Store/Location:</label>
                                    <div class="input-group">
                                        <select id="stationId" name="stationId" class="form-select form-select-sm">
                                            <option value="">Select Store</option>
                                            <!-- Options for stores will be dynamically added here -->
                                        </select>
                                        <button class="btn btn-secondary btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#storeModal">
                                            <i class="fa fa-plus-circle"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="billingAddress" class="form-label">Bill To:</label>
                            <textarea class="form-control form-control-sm" id="billingAddress" rows="2" placeholder="Enter billing address"></textarea>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <!-- First Row: Invoice Number and Create From invoiceNumber-->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="invoiceNumber" class="form-label">Invoice Number:</label>
                                    <input type="text" class="form-control form-control-sm" id="invoiceNumber" value="10001" >
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="transactionType" class="form-label">Create From:</label>
                                    <select class="form-control form-control-sm" id="transactionType">
                                        <option value="cashsale" selected>New Purchase</option>
                                        <option value="invoice">Purchase Order</option>
                                        <option value="quote">Quote</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <!-- Second Row: Date and Terms -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="purchaseDate" class="form-label">Date:</label>
                                    <div class="input-group date trxDate">
                                        <input type="text" id="purchaseDate" name="purchaseDate" class="form-control form-control-sm bg-light-200"  readonly/>
                                        <span class="input-group-text input-group-addon"><i class="fa fa-calendar"></i></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="terms" class="form-label">Terms:</label>
                                    <div class="input-group">
                                        <select class="form-control form-control-sm" id="terms">
                                            <option value="COD" selected>COD</option>
                                            <option value="PAY IN DAYS">Pay in Days</option>
                                            <option value="MAX DAYS">Net 30</option>
                                        </select>
                                        <div class="input-group-append">
                                            <input type="number" class="form-control form-control-sm" id="termsDays" value="30" min="0" step="1">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row g-2 align-items-center mt-1">
                    <!-- Search Product -->
                    <div class="col-md-12">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fa fa-barcode"></i></span>
                            <input type="text" class="form-control" placeholder="Search Product..." id="search-pos">
                        </div>
                    </div>
                </div>
                <div class="row mt-1">
                    <div class="col d-flex justify-content-end align-items-center">
                        <a href="#" class="btn btn-success btn-sm me-2" id="savePurchaseTransactionBtn"><i class="fas fa-save fa-lg me-1"></i>Save Record</a>
                        <a href="#" onclick="loadFragment('/products/product-details')" class="btn btn-danger btn-sm me-2" id="viewBtn"><i class="fas fa-list-numeric fa-lg me-1"></i>View</a>
                        <div class="dropdown">
                            <button class="btn btn-info btn-sm dropdown-toggle" type="button" id="moreActionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-ellipsis-v fa-lg"></i>
                            </button>
                            <!-- Dropdown menu structure -->
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="moreActionsDropdown">
                                <hr class="dropdown-divider">
                                <li><a class="dropdown-item text-primary" href="#"><i class="fas fa-search fa-lg me-1"></i>Search Products</a></li>
                                <hr class="dropdown-divider">
                                <li><a class="dropdown-item text-success" href="#" data-bs-toggle="modal" data-bs-target="#productDetailsModal"><i class="fas fa-list fa-lg me-1"></i>Add Extra Details</a></li>
                                <hr class="dropdown-divider">
                                <li><a class="dropdown-item text-info" href="#"><i class="fas fa-balance-scale fa-lg me-1"></i>View Units of Measure</a></li>
                                <hr class="dropdown-divider">
                                <li><a class="dropdown-item text-warning" href="#"><i class="fas fa-tags fa-lg me-1"></i>View Brands</a></li>
                                <hr class="dropdown-divider">
                                <li><a class="dropdown-item text-danger" href="#"><i class="fas fa-receipt fa-lg me-1"></i>View Revenue Codes</a></li>
                                <hr class="dropdown-divider">
                                <li><a class="dropdown-item text-secondary" href="#"><i class="fas fa-percentage fa-lg me-1"></i>View Tax Categories</a></li>
                                <hr class="dropdown-divider">
                            </ul>
                        </div>
                    </div>
                </div>


            </div>
            <hr class="divider mt-0">

            <div class="panel-body mt-0">
                <div id="stockControlPanelBulkUpdates">
                </div>
            </div>
            <!-- END panel -->


    </div>






    <script>
        $(document).ready(function() {
            $('#search-pos').on('keyup', function() {
                var value = $(this).val().toLowerCase();
                $('#member-table tbody tr').filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
                });
            });
        });
    </script>

        <script>

            $(document).ready(function() {
                // Initialize date pickers
                $('.trxDate').datepicker({
                    format: 'dd/mm/yyyy',
                    autoclose: true,
                    todayHighlight: true
                })

                // Set the current date on page load
                var currentDate = new Date();
                var formattedDate = moment(currentDate).format('DD/MM/YYYY');
                $('#purchaseDate').val(formattedDate);

                // Disable manual input for the regDate field
                $('#purchaseDate').prop('readonly', true);

            });
        </script>

    <script>
        $(document).ready(function() {
            // Function to fetch data
            function fetchStaffList() {
                // Show the loading overlay


                // Construct the URL with query parameters
                var url = '/api-bulk/products-database';

                // Make the AJAX request to the server
                $.ajax({
                    url: url,
                    method: 'GET',
                    success: function(response) {

                      /*  $('#stockControlPanelBulkUpdates').html(response);*/
                        productStockManager(response);


                    },
                    error: function() {
                        alert('An error occurred while fetching data.');
                        // Hide the loading overlay

                    }
                });
            }

            fetchStaffList();
        });
    </script>




      <!--  <script>
            function productStockManager(data) {
                var itemsPerPage = 15;
                var currentPage = 1;
                var selectedRows = [];
                var previousSearchQuery = "";
                var editedPrices = {};
                var stockChanges = {};
                var inputValues = {};

                // Add custom scrollbar styling if not already added
                if (!$("#custom-scrollbar-style").length) {
                    $("<style>")
                        .attr("id", "custom-scrollbar-style")
                        .prop("type", "text/css")
                        .html(`
            .table-container::-webkit-scrollbar { width: 8px; }
            .table-container::-webkit-scrollbar-track { background: #f1f1f1; }
            .table-container::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
            .table-container::-webkit-scrollbar-thumb:hover { background: #555; }
        `)
                        .appendTo("head");
                }

                // Create the table and container
                var tableContainer = $('<div class="table-container" style="max-height: 340px; overflow-y: auto;"/>');
                var table = $('<table id="member-table" class="table table-striped table-thead-sticky table-tfoot-sticky table-tbody-bordered table-px-10px table-py-4px table-sm text-nowrap mb-0 table-bordered" style="font-size: 0.7rem;"/>');
                var thead = $('<thead style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 2;"><tr><th><div class="form-check d-flex justify-content-center my-0 mx-n1"><input type="checkbox" class="form-check-input" id="selectAll" /></div></th><th>No</th></tr></thead>');
                var tbody = $('<tbody/>');

                // Create sticky footer
                var tfoot = $("<tfoot></tfoot>").css({
                    "position": "sticky",
                    "bottom": 0,
                    "background-color": "#f8f9fa",
                    "z-index": 1
                });

                // Build table headers
                var headers = ['Product ID', 'Product Code', 'Product Name', 'Category', 'Cost Price', 'Selling Price', 'Discount', 'Tax', 'Quantity', 'Batch Number', 'Expiry Date'];
                headers.forEach(function(header) {
                    thead.find('tr').append('<th>' + header + '</th>');
                });
                table.append(thead);
                table.append(tbody);
                table.append(tfoot);

                tableContainer.append(table);
                $('#stockControlPanelBulkUpdates').html(tableContainer);

                // Select all functionality
                $('#selectAll').on('change', function () {
                    var isChecked = $(this).prop('checked');
                    $('.rowCheckbox').prop('checked', isChecked);
                    selectedRows = isChecked ? getAllRowIndices() : [];
                });

                $(document).on('change', '.rowCheckbox', function () {
                    var rowIndex = $(this).closest('tr').data('original-index');
                    if ($(this).prop('checked')) {
                        selectedRows.push(rowIndex);
                    } else {
                        selectedRows = selectedRows.filter(function (index) {
                            return index !== rowIndex;
                        });
                    }
                    var allChecked = selectedRows.length === $('.rowCheckbox').length;
                    $('#selectAll').prop('checked', allChecked);
                });

                function getAllRowIndices() {
                    return $('.rowCheckbox').map(function (index, element) {
                        return $(element).closest('tr').data('original-index');
                    }).toArray();
                }

                function createPagination(totalItems) {
                    var totalPages = Math.ceil(totalItems / itemsPerPage);

                    var footerRow = $("<tr></tr>");
                    var footerCell = $("<td></td>").attr("colspan", headers.length + 2);

                    var paginationControls = $('<div class="d-flex justify-content-between align-items-center"/>');
                    var leftControls = $('<div class="d-flex align-items-center"/>');
                    var centerControls = $('<div class="d-flex justify-content-center flex-grow-1"/>');
                    var rightControls = $('<div/>');

                    leftControls.append('<select id="itemsPerPage" class="form-select form-select-sm" style="width: auto; margin-right: 10px; font-size: 0.7rem;">' +
                        '<option value="15">15</option>' +
                        '<option value="50">50</option>' +
                        '<option value="100">100</option>' +
                        '<option value="all">All</option>' +
                        '</select>');
                    leftControls.append('<span>Total: ' + totalItems + ' items</span>');

                    centerControls.append('<button class="btn btn-sm btn-outline-primary mx-1" id="prevPage" style="font-size: 0.7rem;">Previous</button>');
                    centerControls.append('<span id="paginationInfo" style="margin: 0 10px; font-size: 0.7rem;"></span>');
                    centerControls.append('<button class="btn btn-sm btn-outline-primary mx-1" id="nextPage" style="font-size: 0.7rem;">Next</button>');

                    rightControls.append('<span>Page <span id="currentPage"></span> of <span id="totalPages"></span></span>');

                    paginationControls.append(leftControls);
                    paginationControls.append(centerControls);
                    paginationControls.append(rightControls);

                    footerCell.append(paginationControls);
                    footerRow.append(footerCell);

                    // Add purchase summary row
                    var summaryRow = $("<tr></tr>");
                    var summaryCell = $("<td></td>").attr("colspan", headers.length + 2);
                    var summaryContent = $('<div class="d-flex justify-content-between align-items-center" style="font-size: 0.7rem;"/>');
                    summaryContent.append('<span>Items: <span id="totalItems">1(0)</span></span>');
                    summaryContent.append('<span>Total: <span id="totalAmount">0.00</span></span>');
                    summaryContent.append('<span>Order Tax: <span id="orderTax">0.00</span></span>');
                    summaryContent.append('<span>Order Discount: <span id="orderDiscount">0.00</span></span>');
                    summaryContent.append('<span>Shipping Cost: <span id="shippingCost">0.00</span></span>');
                    summaryContent.append('<span>Grand Total: <span id="grandTotal">0.00</span></span>');
                    summaryCell.append(summaryContent);
                    summaryRow.append(summaryCell);

                    tfoot.html(footerRow);
                    tfoot.append(summaryRow);

                    $('#itemsPerPage').val(itemsPerPage).on('change', function () {
                        itemsPerPage = $(this).val() === 'all' ? totalItems : parseInt($(this).val());
                        currentPage = 1;
                        displayTableData();
                    });

                    $('#prevPage').on('click', function () {
                        if (currentPage > 1) {
                            currentPage&#45;&#45;;
                            displayTableData();
                        }
                    });

                    $('#nextPage').on('click', function () {
                        if (currentPage < totalPages) {
                            currentPage++;
                            displayTableData();
                        }
                    });
                }

                function displayTableData(filteredData) {
                    var displayData = filteredData || data;
                    var totalItems = displayData.length;
                    var startIndex = (currentPage - 1) * itemsPerPage;
                    var endIndex = itemsPerPage === totalItems ? totalItems : Math.min(startIndex + itemsPerPage, totalItems);
                    var itemsToShow = displayData.slice(startIndex, endIndex);

                    tbody.empty();
                    if (itemsToShow.length === 0) {
                        tbody.append('<tr><td colspan="' + (headers.length + 2) + '" class="text-center">No Records</td></tr>');
                    } else {
                        for (var i = 0; i < itemsToShow.length; i++) {
                            var tr = $('<tr/>').data('original-index', startIndex + i);
                            var rowIndex = startIndex + i;
                            var isChecked = selectedRows.includes(rowIndex);
                            tr.append('<td><div class="form-check d-flex justify-content-center my-0 mx-n1"><input type="checkbox" class="form-check-input rowCheckbox" ' + (isChecked ? 'checked' : '') + ' /></div></td>');
                            tr.append('<td>' + (rowIndex + 1) + '</td>');

                            headers.forEach(function(header) {
                                var productId = itemsToShow[i]['Product ID'];
                                var inputId = header.toLowerCase().replace(' ', '-') + '-' + productId;
                                var value = inputValues[inputId] || itemsToShow[i][header] || '';

                                if (header === 'Quantity' || header === 'Discount' || header === 'Cost Price' || header === 'Batch Number') {
                                    var td = $('<td/>').html('<input id="' + inputId + '" type="text" class="form-control form-control-sm editable-input" value="' + value + '" placeholder="0" style="font-size: 0.7rem;" />');
                                    td.find('input').on('focus input', function() {
                                        updateRowSelection($(this));
                                        inputValues[$(this).attr('id')] = $(this).val();
                                    });
                                } else if (header === 'Expiry Date') {
                                    var td = $('<td/>').html('<input id="' + inputId + '" type="date" class="form-control form-control-sm editable-input" value="' + value + '" style="font-size: 0.7rem;" />');
                                    td.find('input').on('focus change', function() {
                                        updateRowSelection($(this));
                                        inputValues[$(this).attr('id')] = $(this).val();
                                    });
                                } else if (header === 'Tax') {
                                    var td = $('<td/>').html('<input id="' + inputId + '" type="text" class="form-control form-control-sm editable-input" value="' + value + '" placeholder="0" readonly style="font-size: 0.7rem;" />');
                                } else {
                                    var td = $('<td/>').text(value);
                                }
                                tr.append(td);
                            });

                            tbody.append(tr);
                        }
                    }

                    var totalPages = Math.ceil(totalItems / itemsPerPage);
                    $('#currentPage').text(currentPage);
                    $('#totalPages').text(totalPages);
                    $('#paginationInfo').text(startIndex + 1 + ' - ' + endIndex + ' of ' + totalItems);
                    $('#selectAll').prop('checked', selectedRows.length === $('.rowCheckbox').length);

                    $('#prevPage').prop('disabled', currentPage === 1);
                    $('#nextPage').prop('disabled', currentPage === totalPages);

                    updatePurchaseSummary();
                }

                function updateRowSelection(input) {
                    var checkbox = input.closest('tr').find('.rowCheckbox');
                    checkbox.prop('checked', true);
                    var rowIndex = input.closest('tr').data('original-index');
                    if (!selectedRows.includes(rowIndex)) {
                        selectedRows.push(rowIndex);
                    }
                }

                function updatePurchaseSummary() {
                    var total = 0;
                    var itemCount = 0;
                    $('.editable-input').each(function() {
                        var quantity = parseFloat($(this).val()) || 0;
                        var price = parseFloat($(this).closest('tr').find('td:eq(6)').text()) || 0;
                        total += quantity * price;
                        itemCount += quantity;
                    });

                    var orderTax = 0; // This should be calculated based on your tax rules
                    var orderDiscount = parseFloat($('#orderDiscount').text()) || 0;
                    var shippingCost = parseFloat($('#shippingCost').text()) || 0;
                    var grandTotal = total + orderTax - orderDiscount + shippingCost;

                    $('#totalItems').text(itemCount + '(' + $('.editable-input').length + ')');
                    $('#totalAmount').text(total.toFixed(2));
                    $('#orderTax').text(orderTax.toFixed(2));
                    $('#grandTotal').text(grandTotal.toFixed(2));
                }

                displayTableData();
                createPagination(data.length);

                // Handle Search
                $('#search-pos').on('keyup', function () {
                    previousSearchQuery = $(this).val().toLowerCase();
                    var filteredData = data.filter(function (item) {
                        return Object.values(item).some(function (value) {
                            return value.toString().toLowerCase().includes(previousSearchQuery);
                        });
                    });
                    currentPage = 1;
                    displayTableData(filteredData);
                    createPagination(filteredData.length);
                });
            }
        </script>-->
        <script>

            const productStockManager = (data) => {
                let itemsPerPage = 15;
                let currentPage = 1;
                let selectedRows = new Set();
                let previousSearchQuery = "";
                let editedPrices = {};
                let stockChanges = {};
                let inputValues = {};
                let currentViewpoint = 'purchases';

                const viewpoints = {
                    purchases: {
                        headers: ['Product ID', 'Product Code', 'Product Name', 'Category', 'Cost Price', 'Selling Price', 'Discount', 'Tax', 'Quantity', 'Batch Number', 'Expiry Date'],
                        editableFields: ['Quantity', 'Discount', 'Cost Price', 'Batch Number', 'Expiry Date']
                    },
                    stockRequests: {
                        headers: ['Product ID', 'Product Code', 'Product Name', 'Category', 'Quantity Requested', 'Current Stock'],
                        editableFields: ['Quantity Requested']
                    },
                    stockIssuances: {
                        headers: ['Product ID', 'Product Code', 'Product Name', 'Category', 'Batch Number', 'Quantity to Issue', 'Available Quantity'],
                        editableFields: ['Quantity to Issue']
                    },
                    purchaseOrders: {
                        headers: ['Product ID', 'Product Code', 'Product Name', 'Category', 'Quantity to Order', 'Last Purchase Price'],
                        editableFields: ['Quantity to Order']
                    }
                };

                const addCustomScrollbarStyle = () => {
                    if (!$("#custom-scrollbar-style").length) {
                        $("<style>")
                            .attr("id", "custom-scrollbar-style")
                            .prop("type", "text/css")
                            .html(`
                    .table-container::-webkit-scrollbar { width: 8px; }
                    .table-container::-webkit-scrollbar-track { background: #f1f1f1; }
                    .table-container::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
                    .table-container::-webkit-scrollbar-thumb:hover { background: #555; }
                `)
                            .appendTo("head");
                    }
                };

                const createViewpointSelector = () => {
                    const selector = $('<div class="mb-3"></div>');
                    Object.keys(viewpoints).forEach(viewpoint => {
                        const checkbox = $(`
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="viewpoint" id="${viewpoint}" value="${viewpoint}" ${viewpoint === currentViewpoint ? 'checked' : ''}>
                    <label class="form-check-label" for="${viewpoint}">${viewpoint.charAt(0).toUpperCase() + viewpoint.slice(1)}</label>
                </div>
            `);
                        selector.append(checkbox);
                    });
                    selector.on('change', 'input[type=radio]', (e) => {
                        currentViewpoint = e.target.value;
                        selectedRows.clear();
                        createTable();
                        displayTableData();
                    });
                    return selector;
                };

                const createTable = () => {
                    const tableContainer = $('<div class="table-container" style="max-height: 340px; overflow-y: auto;"/>');
                    const table = $('<table id="member-table" class="table table-striped table-thead-sticky table-tfoot-sticky table-tbody-bordered table-px-10px table-py-4px table-sm text-nowrap mb-0 table-bordered" style="font-size: 0.7rem;"/>');
                    const thead = $('<thead style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 2;"><tr><th><div class="form-check d-flex justify-content-center my-0 mx-n1"><input type="checkbox" class="form-check-input" id="selectAll" /></div></th><th>No</th></tr></thead>');
                    const tbody = $('<tbody/>');
                    const tfoot = $("<tfoot></tfoot>").css({
                        "position": "sticky",
                        "bottom": 0,
                        "background-color": "#f8f9fa",
                        "z-index": 1
                    });

                    viewpoints[currentViewpoint].headers.forEach(header => {
                        thead.find('tr').append(`<th>${header}</th>`);
                    });

                    table.append(thead).append(tbody).append(tfoot);
                    tableContainer.append(table);
                    $('#stockControlPanelBulkUpdates').find('.table-container').remove();
                    $('#stockControlPanelBulkUpdates').append(tableContainer);
                    return tableContainer;
                };

                const handleSelectAll = () => {
                    $(document).on('change', '#selectAll', function () {
                        const isChecked = $(this).prop('checked');
                        $('.rowCheckbox').prop('checked', isChecked);
                        if (isChecked) {
                            selectedRows = new Set(getAllRowIndices());
                        } else {
                            selectedRows.clear();
                        }
                    });
                };

                const handleRowSelection = () => {
                    $(document).on('change', '.rowCheckbox', function () {
                        const rowIndex = $(this).closest('tr').data('original-index');
                        if ($(this).prop('checked')) {
                            selectedRows.add(rowIndex);
                        } else {
                            selectedRows.delete(rowIndex);
                        }
                        $('#selectAll').prop('checked', selectedRows.size === $('.rowCheckbox').length);
                    });
                };

                const getAllRowIndices = () => {
                    return Array.from($('.rowCheckbox')).map(element => $(element).closest('tr').data('original-index'));
                };

                const createPagination = (totalItems) => {
                    const totalPages = Math.ceil(totalItems / itemsPerPage);
                    const footerRow = $("<tr></tr>");
                    const footerCell = $("<td></td>").attr("colspan", viewpoints[currentViewpoint].headers.length + 2);
                    const paginationControls = $('<div class="d-flex justify-content-between align-items-center"/>');

                    // Left controls
                    const leftControls = $('<div class="d-flex align-items-center"/>');
                    leftControls.append(`
            <select id="itemsPerPage" class="form-select form-select-sm" style="width: auto; margin-right: 10px; font-size: 0.7rem;">
                <option value="15">15</option>
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="all">All</option>
            </select>
        `);
                    leftControls.append(`<span>Total: ${totalItems} items</span>`);

                    // Center controls
                    const centerControls = $('<div class="d-flex justify-content-center flex-grow-1"/>');
                    centerControls.append('<button class="btn btn-sm btn-outline-primary mx-1" id="prevPage" style="font-size: 0.7rem;">Previous</button>');
                    centerControls.append('<span id="paginationInfo" style="margin: 0 10px; font-size: 0.7rem;"></span>');
                    centerControls.append('<button class="btn btn-sm btn-outline-primary mx-1" id="nextPage" style="font-size: 0.7rem;">Next</button>');

                    // Right controls
                    const rightControls = $('<div/>');
                    rightControls.append('<span>Page <span id="currentPage"></span> of <span id="totalPages"></span></span>');

                    paginationControls.append(leftControls).append(centerControls).append(rightControls);
                    footerCell.append(paginationControls);
                    footerRow.append(footerCell);

                    // Add purchase summary row
                    const summaryRow = $("<tr></tr>");
                    const summaryCell = $("<td></td>").attr("colspan", viewpoints[currentViewpoint].headers.length + 2);
                    const summaryContent = $('<div class="d-flex justify-content-between align-items-center" style="font-size: 0.7rem;"/>');
                    summaryContent.append('<span>Items: <span id="totalItems">0(0)</span></span>');
                    summaryContent.append('<span>Total: <span id="totalAmount">0.00</span></span>');
                    summaryContent.append('<span>Order Tax: <span id="orderTax">0.00</span></span>');
                    summaryContent.append('<span>Order Discount: <span id="orderDiscount">0.00</span></span>');
                    summaryContent.append('<span>Shipping Cost: <span id="shippingCost">0.00</span></span>');
                    summaryContent.append('<span>Grand Total: <span id="grandTotal">0.00</span></span>');
                    summaryCell.append(summaryContent);
                    summaryRow.append(summaryCell);

                    $('tfoot').html(footerRow).append(summaryRow);

                    $('#itemsPerPage').val(itemsPerPage).on('change', function () {
                        itemsPerPage = $(this).val() === 'all' ? totalItems : parseInt($(this).val());
                        currentPage = 1;
                        displayTableData();
                    });

                    $('#prevPage').on('click', () => {
                        if (currentPage > 1) {
                            currentPage--;
                            displayTableData();
                        }
                    });

                    $('#nextPage').on('click', () => {
                        if (currentPage < totalPages) {
                            currentPage++;
                            displayTableData();
                        }
                    });
                };

                const displayTableData = (filteredData) => {
                    const displayData = filteredData || data;
                    const totalItems = displayData.length;
                    const startIndex = (currentPage - 1) * itemsPerPage;
                    const endIndex = itemsPerPage === totalItems ? totalItems : Math.min(startIndex + itemsPerPage, totalItems);
                    const itemsToShow = displayData.slice(startIndex, endIndex);

                    $('tbody').empty();
                    if (itemsToShow.length === 0) {
                        $('tbody').append(`<tr><td colspan="${viewpoints[currentViewpoint].headers.length + 2}" class="text-center">No Records</td></tr>`);
                    } else {
                        itemsToShow.forEach((item, index) => {
                            const rowIndex = startIndex + index;
                            const tr = $('<tr/>').data('original-index', rowIndex);
                            const isChecked = selectedRows.has(rowIndex);
                            tr.append(`<td><div class="form-check d-flex justify-content-center my-0 mx-n1"><input type="checkbox" class="form-check-input rowCheckbox" ${isChecked ? 'checked' : ''} /></div></td>`);
                            tr.append(`<td>${rowIndex + 1}</td>`);

                            viewpoints[currentViewpoint].headers.forEach(header => {
                                const productId = item['Product ID'];
                                const inputId = `${header.toLowerCase().replace(' ', '-')}-${productId}`;
                                const value = inputValues[inputId] || item[header] || '';

                                if (viewpoints[currentViewpoint].editableFields.includes(header)) {
                                    if (header === 'Expiry Date') {
                                        const td = $('<td/>').html(`<input id="${inputId}" type="date" class="form-control form-control-sm editable-input" value="${value}" style="font-size: 0.7rem;" />`);
                                        td.find('input').on('focus change', function() {
                                            updateRowSelection($(this));
                                            inputValues[$(this).attr('id')] = $(this).val();
                                        });
                                        tr.append(td);
                                    } else {
                                        const td = $('<td/>').html(`<input id="${inputId}" type="text" class="form-control form-control-sm editable-input" value="${value}" placeholder="0" style="font-size: 0.7rem;" />`);
                                        td.find('input').on('focus input', function() {
                                            updateRowSelection($(this));
                                            inputValues[$(this).attr('id')] = $(this).val();
                                        });
                                        tr.append(td);
                                    }
                                } else {
                                    tr.append($('<td/>').text(value));
                                }
                            });

                            $('tbody').append(tr);
                        });
                    }

                    updatePaginationInfo(totalItems, startIndex, endIndex);
                    updatePurchaseSummary();
                };

                const updatePaginationInfo = (totalItems, startIndex, endIndex) => {
                    const totalPages = Math.ceil(totalItems / itemsPerPage);
                    $('#currentPage').text(currentPage);
                    $('#totalPages').text(totalPages);
                    $('#paginationInfo').text(`${startIndex + 1} - ${endIndex} of ${totalItems}`);
                    $('#selectAll').prop('checked', selectedRows.size === $('.rowCheckbox').length);
                    $('#prevPage').prop('disabled', currentPage === 1);
                    $('#nextPage').prop('disabled', currentPage === totalPages);
                };

                const updateRowSelection = (input) => {
                    const checkbox = input.closest('tr').find('.rowCheckbox');
                    checkbox.prop('checked', true);
                    const rowIndex = input.closest('tr').data('original-index');
                    selectedRows.add(rowIndex);
                };

                const updatePurchaseSummary = () => {
                    let total = 0;
                    let itemCount = 0;
                    $('.editable-input').each(function() {
                        const quantity = parseFloat($(this).val()) || 0;
                        const price = parseFloat($(this).closest('tr').find('td:eq(6)').text()) || 0;
                        total += quantity * price;
                        itemCount += quantity;
                    });

                    const orderTax = 0; // This should be calculated based on your tax rules
                    const orderDiscount = parseFloat($('#orderDiscount').text()) || 0;
                    const shippingCost = parseFloat($('#shippingCost').text()) || 0;
                    const grandTotal = total + orderTax - orderDiscount + shippingCost;

                    $('#totalItems').text(`${itemCount}(${$('.editable-input').length})`);
                    $('#totalAmount').text(total.toFixed(2));
                    $('#orderTax').text(orderTax.toFixed(2));
                    $('#grandTotal').text(grandTotal.toFixed(2));
                };

                const handleSearch = () => {
                    $('#search-pos').on('keyup', function () {
                        previousSearchQuery = $(this).val().toLowerCase();
                        const filteredData = data.filter(item =>
                            Object.values(item).some(value =>
                                value.toString().toLowerCase().includes(previousSearchQuery)
                            )
                        );
                        currentPage = 1;
                        displayTableData(filteredData);
                        createPagination(filteredData.length);
                    });
                };

                const setupArrowNavigation = () => {
                    $(document).on('keydown', '.editable-input', function(e) {
                        const currentInput = $(this);
                        const currentRow = currentInput.closest('tr');
                        const currentIndex = currentRow.find('.editable-input').index(currentInput);

                        switch(e.which) {
                            case 38: // up arrow
                                const prevRow = currentRow.prev();
                                if (prevRow.length) {
                                    prevRow.find('.editable-input').eq(currentIndex).focus();
                                }
                                break;
                            case 40: // down arrow
                                const nextRow = currentRow.next();
                                if (nextRow.length) {
                                    nextRow.find('.editable-input').eq(currentIndex).focus();
                                }
                                break;
                            case 37: // left arrow
                                currentInput.prev('.editable-input').focus();
                                break;
                            case 39: // right arrow
                                currentInput.next('.editable-input').focus();
                                break;
                        }
                    });
                };

                const init = () => {
                    addCustomScrollbarStyle();
                    $('#stockControlPanelBulkUpdates').html(createViewpointSelector());
                    createTable();
                    handleSelectAll();
                    handleRowSelection();
                    displayTableData();
                    createPagination(data.length);
                    handleSearch();
                    setupArrowNavigation();
                };

                init();
            };


        </script>




    <script>
        $(document).ready(function() {
            // Initialize Select2
            $("#stationId").select2({
                ajax: {
                    url: "/api/branches/branches-list",
                    dataType: 'json',
                    delay: 250,
                    data: function(params) {
                        return {
                            keyword: params.term
                        };
                    },
                    processResults: function(data) {
                        console.log(data);
                        return {
                            results: $.map(data, function(obj) {
                                return {
                                    id: obj.id,
                                    value: obj.id,
                                    text: obj.id + ' - ' + obj.branchName,
                                    branchId: obj.id // add the branchId to the option
                                };
                            })
                        };
                    }
                },
                minimumInputLength: 1
            });
        });
    </script>


    <script>
        $(document).ready(function() {
            // Initialize Select2
            $("#supplierId").select2({
                ajax: {
                    url: "/api/suppliers/search",
                    dataType: 'json',
                    delay: 250,
                    data: function(params) {
                        return {
                            keyword: params.term
                        };
                    },
                    processResults: function(data) {
                        console.log(data);
                        return {
                            results: $.map(data, function(obj) {
                                return {
                                    id: obj.id,
                                    value: obj.id,
                                    text: obj.id + ' - ' + obj.creditorName,
                                    supplierId: obj.id // add the supplierId to the option
                                };
                            })
                        };
                    }
                },
                minimumInputLength: 1
            });
        });
    </script>




        <script>
            const savePurchaseTransaction = async () => {
                showLoading();
                const supplierId = $('#supplierId').val();
                const branchId = $('#stationId').val();

                if (!supplierId) {
                    handleError('Please select a supplier.');
                    return;
                }

                const products = $('.rowCheckbox:checked')
                    .map((_, checkbox) => {
                        const $row = $(checkbox).closest('tr');
                        const productId = $row.find('td:eq(2)').text();
                        const quantity = $row.find('input[id^="quantity-"]').val();
                        const unitPrice = $row.find('input[id^="cost-price-"]').val();
                        const batchNumber = $row.find('input[id^="batch-number-"]').val();
                        const expiryDate = $row.find('input[id^="expiry-date-"]').val();

                        if (!validateNumericInput(quantity) || !validateNumericInput(unitPrice)) {
                            throw new Error(`Invalid quantity or unit price for product ${productId}`);
                        }
                        if (expiryDate && !validateDateInput(expiryDate)) {
                            throw new Error(`Invalid expiry date format for product ${productId}`);
                        }

                        const product = {
                            productId: parseInt(productId),
                            quantity: parseInt(quantity),
                            unitPrice: parseFloat(unitPrice)
                        };
                        if (batchNumber) product.batchNumber = batchNumber;
                        if (expiryDate) product.expiryDate = expiryDate;
                        return product;
                    })
                    .get()
                    .filter(product => product.quantity > 0);

                if (products.length === 0) {
                    handleError('Please select at least one product with a quantity.');
                    return;
                }

                const purchaseTransactionDTO = {
                    supplierId: parseInt(supplierId),
                    branchId: parseInt(branchId),
                    products
                };

                console.log('Purchase Transaction DTO:', purchaseTransactionDTO);

                try {
                    const response = await $.ajax({
                        url: '/api/stock-transactions/purchases',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(purchaseTransactionDTO)
                    });

                    const statusCode = response.status;
                    let message;

                    if (statusCode === 200) {
                        message = 'Purchase transaction updated successfully';
                    } else if (statusCode === 201) {
                        message = 'Purchase transaction created successfully';
                    } else {
                        message = 'Purchase transaction processed successfully';
                    }

                    showNotification('success', message);
                    clearForm();
                } catch (error) {
                    handleError(`Error processing purchase transaction: ${error.responseText || error.statusText}`);
                } finally {
                    hideLoading();
                }
            };

            const refreshTable = () => {
                $('.rowCheckbox, #selectAll').prop('checked', false);
                selectedRows = [];
                stockChanges = {};
                currentPage = 1;
                fetchProductList();
            };

            const showLoading = () => $('#loading-overlay').show();
            const hideLoading = () => $('#loading-overlay').hide();


            const showNotification = (type, message) => {
                $.wnoty({ type, message, position: 'top-right' });
            };

            const validateNumericInput = input => !isNaN(parseFloat(input)) && isFinite(input);
            const validateDateInput = input => /^\d{4}-\d{2}-\d{2}$/.test(input);

            const handleError = (message) => {
                console.error(message);
                showNotification('error', message);
                hideLoading();
            };

            const clearForm = () => {
                $('#supplierId, #transactionDescription').val('');
                $('.editable-input').val('');
                refreshTable();
            };

            $('#savePurchaseTransactionBtn').on('click', savePurchaseTransaction);
        </script>




















</div>



