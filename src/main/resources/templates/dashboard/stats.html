


<div th:fragment="pos-main" xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6" sec:authorize="hasAuthority('Admin')">

    <style type="text/css">


        /* Set flexbox for the pos-container */
        .pos-container {
            display: flex;
            flex-direction: column;
            height: auto;
        }

        /* Set flex for pos-content */
        .pos-content {
            display: flex;
            flex: 1;
        }

        /* Style pos-content-container */
        .pos-content-container {
            flex: 1;
            padding: 10px;
        }


        .stats-row {
            margin-bottom: 10px;
        }

        .stats-card {
            background-color: #fff;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            display: flex;
            align-items: stretch;
            height: 68px;
            overflow: hidden;
        }

        .icon-box {
            width: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-box i {
            font-size: 40px;
            color: #fff;
        }

        .stats-content {
            flex-grow: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stats-content h3 {
            font-size: 24px;
            margin: 0;
            line-height: 1;
        }

        .stats-content p {
            margin: 5px 0 0;
            font-size: 14px;
            color: #777;
        }

        .stats-content small {
            font-size: 12px;
            color: #999;
        }


    </style>


    <div class="row">
        <div class="col-md-12">
            <div class="card p-1">
                <div class="pos-container">

                    <!-- pos-content -->
                    <div class="pos-content">
                        <div class="col-md-12">

                            <div class="card mb-1">

                                <div class="card-body">

                                    <div class="row stats-row mb-1">
                                        <!-- Total Cash -->
                                        <div class="col-md-3">
                                            <div class="stats-card">
                                                <div class="icon-box" style="background-color: #32CD32;">
                                                    <ion-icon name="cash-outline" style="font-size: 32px; color: #FFFFFF;"></ion-icon>
                                                </div>
                                                <div class="stats-content">
                                                    <h3 id="totalCashCount">0</h3>
                                                    <p>Total Bills</p>
                                                    <small id="totalCashChange">0% Previous</small>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Total Invoices -->
                                        <div class="col-md-3">
                                            <div class="stats-card">
                                                <div class="icon-box" style="background-color: #4169E1;">
                                                    <ion-icon name="receipt-outline" style="font-size: 32px; color: #FFFFFF;"></ion-icon>
                                                </div>
                                                <div class="stats-content">
                                                    <h3 id="totalInvoicesCount">0</h3>
                                                    <p>Total Cleared</p>
                                                    <small id="totalInvoicesChange">0% Previous</small>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Total Patients Cash -->
                                        <div class="col-md-3">
                                            <div class="stats-card">
                                                <div class="icon-box" style="background-color: #FF8C00;">
                                                    <ion-icon name="wallet-outline" style="font-size: 32px; color: #FFFFFF;"></ion-icon>
                                                </div>
                                                <div class="stats-content">
                                                    <h3 id="cashPatientsCount">0</h3>
                                                    <p>Total Uncleared</p>
                                                    <small id="cashPatientsChange">0% Previous</small>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Total Insurance Patients -->
                                        <div class="col-md-3">
                                            <div class="stats-card">
                                                <div class="icon-box" style="background-color: #9370DB;">
                                                    <ion-icon name="shield-checkmark-outline" style="font-size: 32px; color: #FFFFFF;"></ion-icon>
                                                </div>
                                                <div class="stats-content">
                                                    <h3 id="insurancePatientsCount">0</h3>
                                                    <p>Net Profit</p>
                                                    <small id="insurancePatientsChange">0% Previous</small>
                                                </div>
                                            </div>
                                        </div>

                                    </div>


                                </div>
                            </div>


                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-body fw-bold">
                                        <ul class="nav nav-tabs nav-tabs px-1 border">
                                            <!-- Financial & Service Summary Tabs -->
                                            <li class="nav-item me-2">
                                                <a class="nav-link px-2 active" data-bs-toggle="tab" href="#revenue-summary">
                                                    <ion-icon name="cash-outline" class="me-2" style="font-size: 24px; color: #2ecc71;"></ion-icon>
                                                    REVENUE SUMMARY
                                                </a>
                                            </li>
                                            <li class="nav-item me-2">
                                                <a class="nav-link px-2" data-bs-toggle="tab" href="#stock-reports">
                                                    <ion-icon name="document-text-outline" class="me-2" style="font-size: 24px; color: #9b59b6;"></ion-icon>
                                               BRANCH STOCK SHEETS
                                                </a>
                                            </li>
                                            <li class="nav-item me-2">
                                                <a class="nav-link px-2" data-bs-toggle="tab" href="#counter-stores">
                                                    <ion-icon name="cart-outline" class="me-2" style="font-size: 24px; color: #2ecc71;"></ion-icon>
                                                    BRANCH MANAGEMENT TRACKING
                                                </a>
                                            </li>

                                            <li class="nav-item me-2">
                                                <a class="nav-link px-2" data-bs-toggle="tab" href="#monthly-sales">
                                                    <ion-icon name="cart-outline" class="me-2" style="font-size: 24px; color: #2ecc71;"></ion-icon>
                                                    BRANCH MONTHLY SALES
                                                </a>
                                            </li>

                                            <!-- Additional Hospital Services -->
                                        </ul>
                                        <div class="tab-content border">
                                            <!-- Financial Summary Content -->
                                            <div id="revenue-summary" class="tab-pane fade show active">
                                                <!-- Shows revenue summary -->
                                            </div>

                                            <!-- Time Period Based Content -->
                                            <div id="stock-reports" class="tab-pane fade">
                                                <!-- Shows monthly reports -->
                                            </div>

                                            <div id="counter-stores" class="tab-pane fade">
                                                <!-- Shows monthly reports -->
                                            </div>

                                            <div id="monthly-sales" class="tab-pane fade">
                                                <!-- Shows monthly reports -->
                                            </div>




                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>


                    </div>
                    <!-- END pos-content -->

                </div>
            </div>
        </div>
    </div>









    <script>
        $(() => {
            // Format numbers with commas
            const formatNumber = (number) => {
                if (!number) return "0.00";
                return parseFloat(number.toString().replace(/,/g, '')).toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            };

            // Update change percentage display
            const updateChangeText = (elementId, changeValue, timePeriod) => {
                let changeText = '';
                let changeClass = '';
                if (parseFloat(changeValue) > 0) {
                    changeText = `↑ ${changeValue}%`;
                    changeClass = 'text-success';
                } else if (parseFloat(changeValue) < 0) {
                    changeText = `↓ ${Math.abs(changeValue)}%`;
                    changeClass = 'text-danger';
                } else {
                    changeText = `${changeValue || 0}%`;
                    changeClass = 'text-muted';
                }
                $(`#${elementId}`).html(`<span class="${changeClass}">${changeText}</span> ${timePeriod}`);
            };

            // Update stats cards
            const updateStats = (data) => {
                const totals = data.find(item => item['Revenue Category'] === 'TOTAL');
                if (totals) {
                    $('#totalCashCount').html(formatNumber(totals['Current Total Amount']));
                    $('#totalInvoicesCount').html(formatNumber(totals['Current Paid Amount']));
                    $('#cashPatientsCount').html(formatNumber(totals['Current Pending Amount']));
                    $('#insurancePatientsCount').html(formatNumber(totals['Current Profit']));

                    updateChangeText('totalCashChange', totals['Total Amount Change %'], 'Since last month');
                    updateChangeText('totalInvoicesChange', totals['Paid Amount Change %'], 'Since last month');
                    updateChangeText('cashPatientsChange', totals['Pending Amount Change %'], 'Since last month');
                    updateChangeText('insurancePatientsChange', totals['Profit Change %'], 'Since last month');
                }
            };

            // Create and update revenue table
            const updateRevenueTable = (data) => {
                const tableHtml = `
            <div class="table-responsive mt-3">
                <table class="table table-bordered table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Revenue Category</th>
                            <th>Current Total</th>
                            <th>Change %</th>
                            <th>Current Paid</th>
                            <th>Current Pending</th>
                            <th>Current Profit</th>
                            <th>Profit Margin %</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(row => `
                            <tr ${row['Revenue Category'] === 'TOTAL' ? 'class="table-primary fw-bold"' : ''}>
                                <td>${row['Revenue Category']}</td>
                                <td>${formatNumber(row['Current Total Amount'])}</td>
                                <td class="${parseFloat(row['Total Amount Change %']) > 0 ? 'text-success' : 'text-danger'}">
                                    ${parseFloat(row['Total Amount Change %']) > 0 ? '↑' : '↓'} ${Math.abs(parseFloat(row['Total Amount Change %'])).toFixed(2)}%
                                </td>
                                <td>${formatNumber(row['Current Paid Amount'])}</td>
                                <td>${formatNumber(row['Current Pending Amount'])}</td>
                                <td>${formatNumber(row['Current Profit'])}</td>
                                <td>${parseFloat(row['Current Profit Margin %']).toFixed(2)}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
                $('#revenue-table').html(tableHtml);
            };

            // Fetch data based on selected date and branch
            const fetchData = (date, branchId) => {
                if (!branchId) {
                    $('#revenue-table').html('<div class="alert alert-warning">Please select a branch</div>');
                    return;
                }

                $.ajax({
                    url: `/api/products-manager/revenue-movement/${date}/${branchId}`,
                    type: 'GET',
                    dataType: 'json',
                    success: (response) => {
                        if (Array.isArray(response) && response.length > 0) {
                            updateStats(response);
                            updateRevenueTable(response);
                        } else {
                            $('#revenue-table').html('<div class="alert alert-info">No data available for selected date and branch</div>');
                        }
                    },
                    error: (xhr, status, error) => {
                        console.error('Error fetching data:', error);
                        $('#revenue-table').html('<div class="alert alert-danger">Error loading data</div>');
                    }
                });
            };

            // Initialize UI with date picker and branch selector
            const initializeUI = () => {
                const today = new Date().toISOString().split('T')[0];
                $('#revenue-summary').html(`
                <div class="p-3" id="revenueSummary">
                    <div class="row align-items-center mb-3">
                        <div class="col-md-4">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <ion-icon name="calendar-outline"></ion-icon>
                                </span>
                                <input type="date" class="form-control" id="revenueSummaryDatePicker" value="${today}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <select id="revenueSummaryBranchSelect" class="form-control select2-branch" style="width: 100%"></select>
                        </div>
                    </div>
                    <div id="revenue-table"></div>
                </div>
            `);

                // Initialize Select2 for branch selection
                $('#revenueSummaryBranchSelect').select2({
                    placeholder: 'Select a branch',
                    allowClear: true,
                    ajax: {
                        url: '/api/branches/branches-list',
                        dataType: 'json',
                        delay: 250,
                        data: function(params) {
                            return {
                                keyword: params.term || ''
                            };
                        },
                        processResults: function(data) {
                            return {
                                results: data.map(branch => ({
                                    id: branch.id,
                                    text: `${branch.branchName} (${branch.branchCode})`
                                }))
                            };
                        },
                        cache: true
                    },
                    minimumInputLength: 0
                });

                // Event listeners
                let selectedDate = today;
                let selectedBranchId = null;

                $('#revenueSummaryDatePicker').on('change', function() {
                    selectedDate = $(this).val();
                    if (selectedBranchId) {
                        fetchData(selectedDate, selectedBranchId);
                    }
                });

                $('#revenueSummaryBranchSelect').on('change', function() {
                    selectedBranchId = $(this).val();
                    if (selectedBranchId) {
                        fetchData(selectedDate, selectedBranchId);
                    } else {
                        $('#revenue-table').html('<div class="alert alert-warning">Please select a branch</div>');
                    }
                });
            };

            // Start the application
            initializeUI();
        });
    </script>



    <script>
        $(document).ready(function() {
            // Function to load content based on the URL
            function loadContent(url, tabId) {
                $.ajax({
                    url: url,
                    type: 'GET',
                    success: function(response) {
                        $(tabId).html(response);
                        // Only clear siblings that are not revenue-summary
                        $(tabId).siblings('.tab-pane').not('#revenue-summary').empty();
                    },
                    error: function() {
                        $(tabId).html('<div class="p-3"><div class="alert alert-danger">No content. Please try again.</div></div>');
                    }
                });
            }

            // Function to get URL based on tab ID
            function getUrlForTab(tabId) {
                const urlMapping = {
                    '#stock-reports': '/monthly-summary-data',
                    '#monthly-sales':'/month-sales-summary',
                    '#counter-stores': '/valuation-summary'
                };
                return urlMapping[tabId] || null;
            }



            // Handle click event on navigation tabs
            $('.nav-link').on('click', function(e) {
                e.preventDefault();
                const tabId = $(this).attr('href');

                // Skip AJAX loading for revenue tab
                if (tabId === '#revenue-summary') {
                    $('.nav-link').removeClass('active');
                    $(this).addClass('active');
                    $(tabId).tab('show');
                    return;
                }

                const url = getUrlForTab(tabId);
                if (!url) {
                    console.error('No URL mapping found for tab:', tabId);
                    return;
                }

                // Update active state of tabs
                $('.nav-link').removeClass('active');
                $(this).addClass('active');

                // Load the content for the clicked tab
                loadContent(url, tabId);

                // Show the clicked tab
                $(tabId).tab('show');
            });

            // Handle URL parameters on page load
            function handleUrlParameters() {
                const urlParams = new URLSearchParams(window.location.search);
                const activeTab = urlParams.get('tab');

                if (activeTab) {
                    const tabSelector = `#${activeTab}`;
                    const $tab = $(`a[href="${tabSelector}"]`);
                    if ($tab.length) {
                        $tab.click();
                    }
                }
            }

            // Call handle URL parameters on initial load
            handleUrlParameters();

            // Update URL when tab changes
            $('.nav-link').on('shown.bs.tab', function(e) {
                const tabId = $(e.target).attr('href').replace('#', '');
                const newUrl = new URL(window.location);
                newUrl.searchParams.set('tab', tabId);
                window.history.pushState({}, '', newUrl);
            });
        });
    </script>




</div>






